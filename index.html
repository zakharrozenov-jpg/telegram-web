<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>Case Hunters ‚Äî CS:GO Style (Demo)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f14;
  --card:#111827;
  --accent:#facc15;
  --muted:#9ca3af;
  --green:#10b981;
  --yellow-line:#facc15;
  --glow: rgba(250,204,21,0.18);
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue";background:var(--bg);color:#fff;padding-top:180px}
#topBar{position:fixed;top:70px;left:0;right:0;background:#020617;padding:12px 18px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.6);z-index:40}
#logo{font-family:'Russo One',sans-serif;font-size:22px;color:var(--accent)}
#balanceBox{padding:8px 14px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#eab308);color:#020617;font-weight:bold;box-shadow:0 0 15px rgba(250,204,21,.6)}
.small{font-size:12px;opacity:.85;color:#d1d5db}
.container{max-width:980px;margin:0 auto;padding:20px 12px 160px}
.section{background:var(--card);border-radius:16px;padding:14px;margin:12px 0}
.case,.item{display:flex;justify-content:space-between;align-items:center;background:#1f2937;border-radius:12px;padding:10px;margin:8px 0;cursor:pointer}
.case:hover{background:#374151}
.case .left, .item .left{display:flex;gap:12px;align-items:center}
.case .meta, .item .meta{display:flex;flex-direction:column}
.case .meta .title, .item .meta .title{font-weight:bold}
.case .meta .sub, .item .meta .sub{font-size:12px;color:var(--muted)}
.smallBtn{background:#111827;border:1px solid #2b3440;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.openBtn{background:var(--green);border:none;padding:10px 14px;border-radius:12px;color:#fff;font-weight:bold;font-size:14px;cursor:pointer}
.openBtn:disabled{opacity:.5;cursor:not-allowed}
.weapon-img{width:64px;height:64px;border-radius:8px;object-fit:cover;box-shadow:0 0 8px #0008;background:#0b0f14;display:block}
.case-badge{width:64px;height:64px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#facc15,#eab308);color:#000;font-weight:900;font-family:'Russo One',sans-serif;box-shadow:0 6px 18px var(--glow);font-size:14px;letter-spacing:1px;position:relative}
.case-badge .label{transform:translateY(1px)}

/* roulette inside case only */
.roulette{overflow:hidden;position:relative;border-radius:14px;height:120px;margin:12px 0;background:linear-gradient(180deg,#071018,#071018);width:100%;max-width:720px;border:2px solid rgba(250,204,21,0.08)}
.track{display:flex;transform:translateX(0);will-change:transform}
.roulette-item{width:120px;flex-shrink:0;text-align:center;font-size:12px;padding:8px}
.roulette-item img{width:84px;height:84px;display:block;margin:0 auto 6px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.6)}
.roulette-center-line{position:absolute;left:50%;top:0;transform:translateX(-50%);width:6px;height:100%;background:linear-gradient(180deg,var(--yellow-line),rgba(250,204,21,0.6));box-shadow:0 0 18px rgba(250,204,21,0.25);pointer-events:none;border-radius:3px}
.roulette-glow{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:220px;height:220px;border-radius:50%;background:radial-gradient(circle, rgba(250,204,21,0.06), transparent 40%);pointer-events:none}

/* spin pulse */
@keyframes spinPulse {0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
.track.spinPulse{animation:spinPulse 900ms ease-in-out}

/* full-screen win overlay */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:120;padding:20px}
#modal{background:transparent;border-radius:18px;padding:0;width:100%;max-width:980px;display:flex;align-items:center;justify-content:center}
#winResultBox{width:100%;max-width:820px;padding:28px;background:linear-gradient(180deg,#071018,#08121a);border-radius:14px;border:4px solid var(--accent);text-align:center;display:none;animation:winPulse 0.6s ease-in-out;color:#fff}
@keyframes winPulse{0%{transform:scale(.8);opacity:0}50%{transform:scale(1.06)}100%{transform:scale(1);opacity:1}}
#winResultBox img{width:220px;height:220px;border-radius:12px;margin:0 auto 14px;box-shadow:0 0 40px rgba(250,204,21,.18)}
#winResultBox .winTitle{font-size:28px;font-weight:800;color:var(--accent);margin-bottom:8px}
#winResultBox .winPrice{font-size:20px;color:#4ecdc4;margin-bottom:6px}
#winResultBox .winNote{font-size:14px;color:#cbd5e1}

/* admin panel */
#adminPanel{position:fixed;right:18px;top:120px;background:#0b1220;border:1px solid #1f2937;padding:12px;border-radius:10px;z-index:60;min-width:260px;display:none}
#adminPanel h4{margin:0 0 8px 0}
.adminRow{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.adminRow input, .adminRow select{padding:6px;border-radius:6px;border:none;background:#071018;color:#fff}
.adminBtn{background:#111827;border:1px solid #2b3440;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}

/* chat & fake online */
.side-row{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
.chatBox{width:320px;max-height:360px;background:#0b1220;border-radius:10px;padding:10px;overflow:auto;border:1px solid #16202a}
.chatMessage{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,#071018,#08121a);font-size:13px}
.chatMessage .meta{font-size:12px;color:#9ca3af;margin-bottom:6px}
.onlineBox{background:#071018;border-radius:10px;padding:10px;color:#cbd5e1;font-size:13px;min-width:160px}
.referral{margin-top:18px;text-align:center;color:#cbd5e1;font-size:13px}
.referral a{color:var(--accent);text-decoration:none;font-weight:bold}
.footerNote{font-size:12px;color:var(--muted);text-align:center;margin:18px 0}
@media (max-width:980px){
  .container{padding:20px 12px 220px}
  .chatBox{width:100%}
}
</style>
</head>
<body>
<div id="topBar">
  <div id="logo">CASE HUNTERS</div>
  <div style="display:flex;align-items:center;gap:12px">
    <div id="balanceBox"><span style="font-size:18px;">üíµ</span> <span id="balance">0</span> ‚ÇΩ</div>
    <button id="bankBtn" class="smallBtn">üíº</button>
    <button id="adminToggle" class="smallBtn" title="–ê–¥–º–∏–Ω–∫–∞">Admin</button>
  </div>
</div>

<div class="container">
  <div style="display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap">
    <div style="flex:1;min-width:320px">
      <div class="section" id="casesSection">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:bold">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–µ–π—Å—ã</div>
          <div class="small">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å" ‚Äî –≤–Ω—É—Ç—Ä–∏ –ø–æ—è–≤–∏—Ç—Å—è —Ä—É–ª–µ—Ç–∫–∞</div>
        </div>
        <div id="casesList"></div>
      </div>

      <div class="section" id="inventorySection">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:bold">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
          <div class="small">–í–∞—à–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</div>
        </div>
        <div id="inventoryList" style="margin-top:12px"></div>
      </div>

      <div class="section" id="refSection" style="margin-top:12px">
        <div style="font-weight:bold">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</div>
        <div class="small" style="margin-top:8px">–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ (–¥–µ–ª–∏—Ç–µ—Å—å —Å –¥—Ä—É–∑—å—è–º–∏):</div>
        <div style="margin-top:8px"><input id="myRefLink" style="width:100%;padding:8px;border-radius:8px;border:none;background:#071018;color:#fff" readonly></div>
        <div class="small" style="margin-top:8px">–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <b>40%</b> –æ—Ç –ø—Ä–æ–∏–≥—Ä—ã—à–∞ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ (–Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å —Ä–µ—Ñ–µ—Ä–µ—Ä–∞).</div>
        <div class="small" style="margin-top:8px">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º: <span id="refEarnings">0</span> ‚ÇΩ</div>
      </div>

      <div class="footerNote">–î–µ–º–æ: —Ä–µ–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã. –î–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–ª–æ–∂–∏—Ç–µ –∏—Ö –≤ <code>/assets/cs/</code> –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ CDN.</div>
    </div>

    <div style="width:340px;min-width:260px">
      <div class="onlineBox" id="onlineBox">
        <div style="font-weight:bold;margin-bottom:6px">–û–Ω–ª–∞–π–Ω</div>
        <div style="font-size:28px;font-weight:800" id="fakeOnline">0</div>
        <div class="small" style="margin-top:6px">–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–µ–π—á–∞—Å</div>
      </div>

      <div style="height:12px"></div>

      <div class="chatBox" id="chatBox" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- admin panel -->
<div id="adminPanel" aria-hidden="true">
  <h4>–ê–¥–º–∏–Ω–∫–∞ (—Ç–µ—Å—Ç)</h4>
  <div class="adminRow">
    <input id="adminPass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
    <button id="adminLogin" class="adminBtn">–í–æ–π—Ç–∏</button>
  </div>
  <div id="adminControls" style="display:none">
    <div class="adminRow">
      <input id="adminAddAmount" type="number" placeholder="–°—É–º–º–∞ +–±–∞–ª–∞–Ω—Å" />
      <button id="adminAddBtn" class="adminBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div class="adminRow">
      <input id="adminSetRtp" type="number" step="0.01" placeholder="RTP (0.5-0.95)" />
      <button id="adminSetRtpBtn" class="adminBtn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å RTP</button>
    </div>
    <div class="adminRow">
      <select id="adminForceCase"></select>
      <select id="adminForceItem"></select>
      <button id="adminForceWin" class="adminBtn">–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à</button>
    </div>
    <div class="adminRow">
      <button id="adminClearRef" class="adminBtn">–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ—Ñ. –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</button>
    </div>
    <div style="font-size:12px;color:#9ca3af;margin-top:8px">–ü–∞—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: <b>admin123</b> (–¥–µ–º–æ)</div>
  </div>
</div>

<!-- bank modal centered -->
<div id="bankOverlay" style="display:none;position:fixed;inset:0;z-index:110;align-items:center;justify-content:center;">
  <div id="bankModal" style="background:#181d27;border-radius:13px;box-shadow:0 4px 32px #000b;padding:22px 32px;display:flex;flex-direction:column;align-items:center;max-width:420px;width:90%;">
    <div style="font-weight:bold;font-size:18px;margin-bottom:8px">–ë–∞–Ω–∫ (–¥–µ–º–æ)</div>
    <div style="margin-bottom:10px;color:#9ca3af;text-align:center">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç –≤ —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏ ‚Äî 100 ‚ÇΩ. –í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –æ—Ç 500 ‚ÇΩ.</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
      <input id="amountInput" type="number" min="100" step="50" value="500" style="padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff;width:120px;text-align:center" />
      <button id="depositBtn" class="smallBtn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å (–¥–µ–º–æ)</button>
      <button id="withdrawBtn" class="smallBtn">–í—ã–≤–µ—Å—Ç–∏</button>
    </div>
    <div style="width:100%;margin-top:8px;border-top:1px solid #222;padding-top:10px">
      <div class="label" style="text-align:center">RTP –∏ —Ç–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ.</div>
    </div>
    <button id="closeBank" style="background:#111827;color:#fff;border-radius:10px;padding:8px 16px;border:none;cursor:pointer;margin-top:12px">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- full-screen win overlay -->
<div id="overlay">
  <div id="modal">
    <div id="winResultBox">
      <img id="winImg" src="" alt="win">
      <div class="winTitle" id="winTitle">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏</div>
      <div class="winPrice" id="winPrice">0 ‚ÇΩ</div>
      <div class="winNote" id="winNote">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.</div>
      <div style="margin-top:14px"><button id="closeModal" class="smallBtn">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
  </div>
</div>

<script>
/* ============================
   –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–¥–µ–º–æ)
   ============================ */

/* --- –£—Ç–∏–ª–∏—Ç—ã –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ --- */
const BALANCE_KEY = 'ch_balance';
const REF_KEY = 'ch_referrer'; // —Ö—Ä–∞–Ω–∏—Ç id —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const REF_EARN_KEY_PREFIX = 'ch_refearn_'; // prefix + refId -> earnings stored for referrer
const USER_ID_KEY = 'ch_userid'; // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π id —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

function uid(prefix='u'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

function getUserId(){
  let id = localStorage.getItem(USER_ID_KEY);
  if(!id){ id = uid('user'); localStorage.setItem(USER_ID_KEY, id); }
  return id;
}
const CURRENT_USER = getUserId();

function loadBalance(){
  try{
    const raw = localStorage.getItem(BALANCE_KEY + '_' + CURRENT_USER);
    if(raw === null) return 0;
    const n = Number(raw);
    return Number.isFinite(n) ? n : 0;
  }catch(e){ return 0; }
}
function saveBalance(v){
  try{ localStorage.setItem(BALANCE_KEY + '_' + CURRENT_USER, String(v)); }catch(e){}
}
function setBalance(v){
  state.balance = Math.max(0, Math.round(Number(v) || 0));
  updateBalanceUI();
  saveBalance(state.balance);
}
function addBalance(v){ setBalance(state.balance + Math.round(Number(v)||0)); }
function subBalance(v){ setBalance(Math.max(0, state.balance - Math.round(Number(v)||0))); }

/* --- Referral helpers --- */
function getReferrerFromUrl(){
  const p = new URLSearchParams(window.location.search);
  return p.get('ref') || null;
}
function setLocalReferrerIfNew(){
  const existing = localStorage.getItem(REF_KEY + '_' + CURRENT_USER);
  if(existing) return existing;
  const ref = getReferrerFromUrl();
  if(ref){
    localStorage.setItem(REF_KEY + '_' + CURRENT_USER, ref);
    return ref;
  }
  return null;
}
function getMyRefLink(){
  // my link uses my user id as ref param
  const base = location.origin + location.pathname;
  return `${base}?ref=${CURRENT_USER}`;
}
function addReferralEarnings(refId, amount){
  if(!refId) return;
  const key = REF_EARN_KEY_PREFIX + refId;
  const cur = Number(localStorage.getItem(key) || 0);
  localStorage.setItem(key, String(Math.round(cur + amount)));
}
function getReferralEarningsForMe(){
  const key = REF_EARN_KEY_PREFIX + CURRENT_USER;
  return Number(localStorage.getItem(key) || 0);
}
function creditReferrerIfApplicable(cost, winPrice){
  // if user has referrer, and the user lost money (cost > winPrice), give 40% of loss to referrer
  const ref = localStorage.getItem(REF_KEY + '_' + CURRENT_USER);
  if(!ref) return;
  const loss = Math.max(0, cost - winPrice);
  if(loss <= 0) return;
  const reward = Math.round(loss * 0.40);
  // store reward under ref's earnings and also add to ref's balance key (simulated)
  addReferralEarnings(ref, reward);
  // also add to ref's balance (if they are on same browser, we simulate by storing balance under their user key)
  try{
    const refBalKey = BALANCE_KEY + '_' + ref;
    const cur = Number(localStorage.getItem(refBalKey) || 0);
    localStorage.setItem(refBalKey, String(cur + reward));
  }catch(e){}
}

/* --- Image helpers --- */
const IMAGE_BASE = '/assets/cs/';
function imgPath(name){ return IMAGE_BASE + name; }
function placeholderDataUrl(name){
  const w=256,h=256,bg='#0b0f14',accent='#facc15';
  const text = name.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect width='100%' height='100%' fill='${bg}'/><rect x='12' y='12' width='${w-24}' height='${h-24}' rx='16' fill='${accent}' opacity='0.12'/><text x='50%' y='50%' font-family='Arial, sans-serif' font-size='18' fill='#e6eef6' text-anchor='middle' dominant-baseline='middle'>${text}</text></svg>`;
  return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
}
function safeSetImg(imgEl, src, name){
  imgEl.src = src;
  imgEl.onerror = function(){ imgEl.onerror = null; imgEl.src = placeholderDataUrl(name); };
}

/* --- Cases: –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –æ—Ä—É–∂–∏—è –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã —Ü–µ–Ω—ã –¥–ª—è –ø—Ä–∏–±—ã–ª–∏ --- */
const BASE_CASES = [
  { id:'case0', name:'Starter Case', price:120, baseItems:[
    { id:'s1', name:'P250 | Sand Dune', price:220, img: imgPath('p250_sanddune.png'), baseChance:55 },
    { id:'s2', name:'USP-S | Torque', price:480, img: imgPath('usp_torque.png'), baseChance:30 },
    { id:'s4', name:'CZ75-Auto | Tigris', price:900, img: imgPath('cz_tigris.png'), baseChance:10 },
    { id:'s3', name:'Nova | Ranger', price:1500, img: imgPath('nova_ranger.png'), baseChance:5 }
  ]},
  { id:'case1', name:'Dust II Case', price:220, baseItems:[
    { id:'g1', name:'AK-47 | Redline', price:900, img: imgPath('ak_redline.png'), baseChance:40 },
    { id:'g2', name:'M4A1-S | Guardian', price:1800, img: imgPath('m4_guardian.png'), baseChance:30 },
    { id:'g5', name:'P90 | Asiimov', price:2600, img: imgPath('p90_asiimov.png'), baseChance:10 },
    { id:'g3', name:'Desert Eagle | Blaze', price:5200, img: imgPath('deagle_blaze.png'), baseChance:20 }
  ]},
  { id:'case1b', name:'Classic Case', price:420, baseItems:[
    { id:'c1', name:'AK-47 | Vulcan', price:7200, img: imgPath('ak_vulcan.png'), baseChance:35 },
    { id:'c2', name:'M4A4 | Howl', price:45000, img: imgPath('m4_howl.png'), baseChance:6 },
    { id:'c4', name:'USP-S | Kill Confirmed', price:12000, img: imgPath('usp_kc.png'), baseChance:20 },
    { id:'c3', name:'Glock-18 | Fade', price:9600, img: imgPath('glock_fade.png'), baseChance:39 }
  ]},
  { id:'case2', name:'Inferno Case', price:980, baseItems:[
    { id:'p1', name:'AWP | Asiimov', price:17600, img: imgPath('awp_asiimov.png'), baseChance:18 },
    { id:'p2', name:'AK-47 | Fire Serpent', price:72000, img: imgPath('ak_serpent.png'), baseChance:25 },
    { id:'p3', name:'M4A1-S | Hot Rod', price:56000, img: imgPath('m4_hotrod.png'), baseChance:45 },
    { id:'p4', name:'FAMAS | Roll Cage', price:4200, img: imgPath('famas_roll.png'), baseChance:12 }
  ]},
  { id:'case3', name:'Mirage Case', price:7200, baseItems:[
    { id:'l1', name:'AWP | Medusa', price:480000, img: imgPath('awp_medusa.png'), baseChance:3 },
    { id:'l2', name:'AK-47 | Fire Serpent (StatTrak)', price:200000, img: imgPath('ak_serpent_st.png'), baseChance:12 },
    { id:'l3', name:'M4A4 | Howl (StatTrak)', price:96000, img: imgPath('m4_howl_st.png'), baseChance:85 }
  ]},
  { id:'gloveCase', name:'Glove Case', price:720, baseItems:[
    { id:'gl1', name:'Sport Gloves | Pandora\'s Box', price:96000, img: imgPath('gloves_pandora.png'), baseChance:40 },
    { id:'gl2', name:'Driver Gloves | King Snake', price:200000, img: imgPath('gloves_kingsnake.png'), baseChance:35 },
    { id:'gl3', name:'Specialist Gloves | Crimson Kimono', price:360000, img: imgPath('gloves_crimson.png'), baseChance:25 }
  ]}
];

const WORK_CASES = BASE_CASES.map(c => {
  const items = c.baseItems.map(it => ({ ...it, chance: it.baseChance }));
  return { ...c, items, baseTotalChance: items.reduce((s,i)=>s+i.baseChance,0) };
});

/* --- –°–æ—Å—Ç–æ—è–Ω–∏–µ --- */
let state = {
  balance: loadBalance(),
  inventory: [],
  currentRtp: 0.65 // –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å
};

/* --- DOM refs --- */
const balanceEl = document.getElementById('balance');
const casesListEl = document.getElementById('casesList');
const inventoryListEl = document.getElementById('inventoryList');
const bankBtn = document.getElementById('bankBtn');
const bankOverlay = document.getElementById('bankOverlay');
const closeBank = document.getElementById('closeBank');
const depositBtn = document.getElementById('depositBtn');
const withdrawBtn = document.getElementById('withdrawBtn');
const amountInput = document.getElementById('amountInput');
const overlay = document.getElementById('overlay');
const winResultBox = document.getElementById('winResultBox');
const winImg = document.getElementById('winImg');
const winTitle = document.getElementById('winTitle');
const winPrice = document.getElementById('winPrice');
const closeModal = document.getElementById('closeModal');
const bonusBtn = document.getElementById('bonusBtn');
const bonusMsg = document.getElementById('bonusMsg');
const chatBox = document.getElementById('chatBox');
const fakeOnlineEl = document.getElementById('fakeOnline');
const myRefLinkInput = document.getElementById('myRefLink');
const refEarningsEl = document.getElementById('refEarnings');

/* admin refs */
const adminToggle = document.getElementById('adminToggle');
const adminPanel = document.getElementById('adminPanel');
const adminLogin = document.getElementById('adminLogin');
const adminPass = document.getElementById('adminPass');
const adminControls = document.getElementById('adminControls');
const adminAddAmount = document.getElementById('adminAddAmount');
const adminAddBtn = document.getElementById('adminAddBtn');
const adminSetRtp = document.getElementById('adminSetRtp');
const adminSetRtpBtn = document.getElementById('adminSetRtpBtn');
const adminForceCase = document.getElementById('adminForceCase');
const adminForceItem = document.getElementById('adminForceItem');
const adminForceWin = document.getElementById('adminForceWin');
const adminClearRef = document.getElementById('adminClearRef');

/* --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–∞ --- */
function initReferralUI(){
  myRefLinkInput.value = getMyRefLink();
  refEarningsEl.textContent = getReferralEarningsForMe();
}

/* --- –†–µ–Ω–¥–µ—Ä –∫–µ–π—Å–æ–≤ (–∫–∞–∂–¥—ã–π –∫–µ–π—Å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä—É–ª–µ—Ç–∫—É) --- */
function renderCases(){
  casesListEl.innerHTML = '';
  WORK_CASES.forEach(c => {
    const el = document.createElement('div'); el.className = 'case'; el.dataset.id = c.id;

    const left = document.createElement('div'); left.className = 'left';
    const badge = document.createElement('div'); badge.className = 'case-badge'; badge.innerHTML = `<div class="label">–ö–ï–ô–°</div>`;
    left.appendChild(badge);

    const meta = document.createElement('div'); meta.className = 'meta';
    meta.innerHTML = `<div class="title">${c.name}</div><div class="sub">–¶–µ–Ω–∞: ${c.price} ‚ÇΩ</div>`;
    left.appendChild(meta);

    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
    right.innerHTML = `<div class="small">–ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${c.items.length}</div><div style="margin-top:6px"><button class="smallBtn" data-open="${c.id}">–û—Ç–∫—Ä—ã—Ç—å</button></div>`;

    const rouletteWrap = document.createElement('div');
    rouletteWrap.className = 'roulette';
    rouletteWrap.style.marginTop = '12px';
    rouletteWrap.style.display = 'none';
    const track = document.createElement('div'); track.className = 'track';
    rouletteWrap.appendChild(track);
    const centerLine = document.createElement('div'); centerLine.className = 'roulette-center-line';
    rouletteWrap.appendChild(centerLine);
    const glow = document.createElement('div'); glow.className = 'roulette-glow';
    rouletteWrap.appendChild(glow);

    el.appendChild(left);
    const centerCol = document.createElement('div');
    centerCol.style.flex = '1';
    centerCol.style.display = 'flex';
    centerCol.style.flexDirection = 'column';
    centerCol.appendChild(meta.cloneNode(true));
    centerCol.appendChild(rouletteWrap);

    el.innerHTML = '';
    el.appendChild(left);
    el.appendChild(centerCol);
    el.appendChild(right);

    prepareRouletteForCase(c, track);

    el.addEventListener('click', (e)=>{
      if(e.target && e.target.dataset && e.target.dataset.open) return;
      toggleCaseRoulette(c.id);
    });
    const openBtn = el.querySelector('button[data-open]');
    openBtn.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      showCaseRoulette(c.id);
      // start 6s spin animation and then reveal
      openCaseWithTimedSpin(c.id, track, 6000);
    });

    casesListEl.appendChild(el);
  });
}

/* --- Show/hide roulette for a case --- */
function toggleCaseRoulette(caseId){
  const caseEl = document.querySelector(`.case[data-id="${caseId}"]`);
  if(!caseEl) return;
  const roulette = caseEl.querySelector('.roulette');
  if(!roulette) return;
  document.querySelectorAll('.case .roulette').forEach(r => { if(r !== roulette) r.style.display = 'none'; });
  roulette.style.display = (roulette.style.display === 'none' || roulette.style.display === '') ? 'block' : 'none';
}
function showCaseRoulette(caseId){
  const caseEl = document.querySelector(`.case[data-id="${caseId}"]`);
  if(!caseEl) return;
  const roulette = caseEl.querySelector('.roulette');
  if(!roulette) return;
  document.querySelectorAll('.case .roulette').forEach(r => { if(r !== roulette) r.style.display = 'none'; });
  roulette.style.display = 'block';
}

/* --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä—É–ª–µ—Ç–∫–∏ –¥–ª—è –∫–µ–π—Å–∞ --- */
function prepareRouletteForCase(caseObj, trackEl){
  trackEl.innerHTML = '';
  const items = [];
  for(let i=0;i<20;i++) caseObj.items.forEach(it => items.push(it));
  items.forEach(it=>{
    const el = document.createElement('div'); el.className = 'roulette-item';
    const img = document.createElement('img'); img.className='weapon-img';
    safeSetImg(img, it.img, it.name);
    el.appendChild(img);
    const name = document.createElement('div'); name.style.fontSize='12px'; name.style.marginTop='6px'; name.textContent = it.name;
    const price = document.createElement('div'); price.className='small'; price.textContent = it.price + ' ‚ÇΩ';
    el.appendChild(name); el.appendChild(price);
    trackEl.appendChild(el);
  });
  trackEl.style.transition = '';
  trackEl.style.transform = 'translateX(0)';
  setTimeout(()=> {
    const container = trackEl.parentElement;
    const containerW = container.clientWidth;
    const trackW = Array.from(trackEl.children).reduce((s, n) => s + (n.offsetWidth || 120), 0);
    if(trackW <= containerW){
      const centerPos = (containerW - trackW)/2;
      trackEl.style.transform = `translateX(${centerPos}px)`;
      trackEl.dataset.minTranslate = trackEl.dataset.maxTranslate = String(centerPos);
    } else {
      const minT = containerW - trackW;
      const maxT = 0;
      trackEl.dataset.minTranslate = String(minT);
      trackEl.dataset.maxTranslate = String(maxT);
      trackEl.style.transform = 'translateX(0)';
    }
  }, 50);
}

/* --- –ê–Ω–∏–º–∞—Ü–∏—è —Ä—É–ª–µ—Ç–∫–∏: 6 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å –∂–µ–ª—Ç–æ–π –ª–∏–Ω–∏–µ–π --- */
function openCaseWithTimedSpin(caseId, trackEl, spinMs = 6000){
  const c = WORK_CASES.find(x=>x.id===caseId);
  if(!c) return;
  const cost = c.price;
  if(state.balance < cost){ showModal(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ ${cost} ‚ÇΩ`, false); return; }

  // —Å–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
  subBalance(cost);

  // prepare spin visuals
  trackEl.classList.add('spinPulse');
  // long spin: animate transform continuously for spinMs, then land on item
  // We'll compute a final translate that centers the winning item.
  const nodes = Array.from(trackEl.children);
  if(nodes.length === 0){
    // fallback: immediate pick
    const win = pickRandomItem(c.items);
    finalizeWin(c, cost, win);
    return;
  }

  // choose winning item now (so we can land on it)
  const win = pickRandomItem(c.items);

  // compute target index (first occurrence)
  let targetIndex = nodes.findIndex(n => n.textContent.includes(win.name));
  if(targetIndex === -1) targetIndex = Math.floor(nodes.length/2);

  const itemWidth = nodes[0].offsetWidth || 120;
  const container = trackEl.parentElement;
  const containerW = container.clientWidth;
  const trackW = nodes.reduce((s,n)=> s + (n.offsetWidth || itemWidth), 0);

  // centerOffset
  const centerOffset = Math.floor(containerW / 2);

  // compute targetCenter for the chosen occurrence
  let targetCenter = 0;
  for(let i=0;i<targetIndex;i++) targetCenter += (nodes[i].offsetWidth || itemWidth);
  targetCenter += (nodes[targetIndex].offsetWidth || itemWidth) / 2;

  // to make a long spin, add several full-track cycles before landing
  const cycles = Math.max(2, Math.floor(spinMs / 1500)); // number of virtual cycles
  const virtualTargetCenter = targetCenter + cycles * trackW;

  let desiredTranslate = centerOffset - virtualTargetCenter;

  // compute min/max
  let minTranslate, maxTranslate;
  if(trackW <= containerW){
    minTranslate = maxTranslate = (containerW - trackW) / 2;
  } else {
    minTranslate = containerW - trackW;
    maxTranslate = 0;
  }

  // normalize desiredTranslate into [minTranslate, maxTranslate] by adding/subtracting trackW
  while(desiredTranslate < minTranslate) desiredTranslate += trackW;
  while(desiredTranslate > maxTranslate) desiredTranslate -= trackW;
  if(desiredTranslate < minTranslate) desiredTranslate = minTranslate;
  if(desiredTranslate > maxTranslate) desiredTranslate = maxTranslate;

  // animate for spinMs duration
  trackEl.style.transition = `transform ${spinMs}ms cubic-bezier(.18,.9,.2,1)`;
  requestAnimationFrame(()=> trackEl.style.transform = `translateX(${desiredTranslate}px)`);

  // after spinMs, finalize
  setTimeout(()=> {
    trackEl.style.transition = '';
    trackEl.classList.remove('spinPulse');
    // finalize: add item to inventory, show full-screen result, credit referrer if loss
    finalizeWin(c, cost, win);
  }, spinMs + 60);
}

/* --- –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–∏–≥—Ä—ã—à–∞: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, –ø–æ–∫–∞–∑, —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è --- */
function finalizeWin(caseObj, cost, win){
  const inv = { uid: uid('it'), id: win.id, name: win.name, price: win.price, img: win.img, upgraded: null };
  state.inventory.push(inv);
  // credit referrer 40% of loss if applicable
  creditReferrerIfApplicable(cost, win.price);
  // show full-screen result
  showFullScreenWin(inv);
  renderInventory();
  logOpen([win]);
  pushFakeChat(`${shortName()} –æ—Ç–∫—Ä—ã–ª ${caseObj.name} –∏ –ø–æ–ª—É—á–∏–ª ${win.name}`);
  // update referral earnings display
  refEarningsEl.textContent = getReferralEarningsForMe();
}

/* --- –í—ã–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞ –ø–æ —à–∞–Ω—Å–∞–º --- */
function pickRandomItem(items){
  const total = items.reduce((s,it)=>s + (it.chance || 1),0);
  let r = Math.random()*total;
  for(const it of items){
    r -= (it.chance || 1);
    if(r <= 0) return JSON.parse(JSON.stringify(it));
  }
  return JSON.parse(JSON.stringify(items[items.length-1]));
}

/* --- –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω --- */
function showFullScreenWin(inv){
  safeSetImg(winImg, inv.img, inv.name);
  winTitle.textContent = inv.name;
  winPrice.textContent = `${inv.price} ‚ÇΩ`;
  document.getElementById('winNote').textContent = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.';
  winResultBox.style.display = 'block';
  overlay.style.display = 'flex';
}

/* --- –õ–æ–≥ –æ—Ç–∫—Ä—ã—Ç–∏—è --- */
function logOpen(results){
  const lines = results.map(r=>`–í—ã –ø–æ–ª—É—á–∏–ª–∏: <b>${r.name}</b> ‚Äî ${r.price} ‚ÇΩ`).join('<br>');
  // –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ª–æ–≥ –≤ UI, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç; –≤ –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –ø—É—à–∏–º –≤ —á–∞—Ç
  pushFakeChat(`–°–∏—Å—Ç–µ–º–∞: ${lines}`);
}

/* --- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å --- */
function renderInventory(){
  inventoryListEl.innerHTML = '';
  if(state.inventory.length === 0){ inventoryListEl.innerHTML = '<div class="small">–ü—É—Å—Ç–æ</div>'; return; }
  state.inventory.slice().reverse().forEach(it=>{
    const el = document.createElement('div'); el.className = 'item';
    const left = document.createElement('div'); left.className='left';
    const img = document.createElement('img'); img.className='weapon-img'; safeSetImg(img, it.img, it.name);
    const meta = document.createElement('div'); meta.className='meta';
    const title = document.createElement('div'); title.className='title'; title.textContent = it.name + (it.upgraded ? ` ‚Ä¢ ${it.upgraded.multiplier}x` : '');
    const sub = document.createElement('div'); sub.className='sub'; sub.textContent = `${it.price} ‚ÇΩ`;
    meta.appendChild(title); meta.appendChild(sub);
    left.appendChild(img); left.appendChild(meta);

    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
    const sellBtn = document.createElement('button'); sellBtn.className='smallBtn'; sellBtn.textContent='–ü—Ä–æ–¥–∞—Ç—å';
    sellBtn.addEventListener('click', ()=>{
      addBalance(it.price);
      const idx = state.inventory.findIndex(x=>x.uid === it.uid);
      if(idx !== -1) state.inventory.splice(idx,1);
      renderInventory();
    });

    const upgBtn = document.createElement('button'); upgBtn.className='smallBtn'; upgBtn.style.marginTop='8px'; upgBtn.textContent='–ê–ø–≥—Ä–µ–π–¥';
    upgBtn.addEventListener('click', ()=> openUpgradePanelForItem(it));

    right.appendChild(sellBtn); right.appendChild(upgBtn);

    el.appendChild(left); el.appendChild(right);
    inventoryListEl.appendChild(el);
  });
}

/* --- –ê–ø–≥—Ä–µ–π–¥ –ø–∞–Ω–µ–ª—å (—É–ø—Ä–æ—â—ë–Ω–Ω–æ) --- */
let upgradeSelectedItem = null;
function openUpgradePanelForItem(item){
  upgradeSelectedItem = item;
  document.getElementById('upgradeSelectedPreview').innerHTML = '';
  const img = document.createElement('img'); img.style.width='64px'; img.style.height='64px'; img.style.borderRadius='8px';
  safeSetImg(img, item.img, item.name);
  document.getElementById('upgradeSelectedPreview').appendChild(img);
  upgradeSelectedName.textContent = item.name;
  upgradeSelectedPrice.textContent = `${item.price} ‚ÇΩ`;
  document.getElementById('upgradeResultSmall').textContent = '';
  document.getElementById('upgradeInnerSmall').textContent = '–ê–ø–≥—Ä–µ–π–¥';
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}
function performUpgrade(multiplier){
  if(!upgradeSelectedItem) { document.getElementById('upgradeResultSmall').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç'; return; }
  const cost = multiplier === 2 ? Math.max(100, Math.round(upgradeSelectedItem.price * 0.18)) : Math.max(200, Math.round(upgradeSelectedItem.price * 0.35));
  if(state.balance < cost){ document.getElementById('upgradeResultSmall').textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'; return; }
  subBalance(cost);
  document.getElementById('upgradeResultSmall').textContent = '–ö—Ä—É—Ç–∏–º...';
  const prob = multiplier === 2 ? 0.60 : 0.30;
  const success = Math.random() < prob;
  const wheel = document.getElementById('upgradeWheelSmall');
  const baseSpins = 3 + Math.floor(Math.random()*3);
  let finalAngle;
  if(success) finalAngle = 360 * baseSpins + (Math.random()*50 + 5);
  else finalAngle = 360 * baseSpins + (Math.random()*180 + 120);
  wheel.style.transition = 'transform 2000ms cubic-bezier(.2,.9,.2,1)';
  wheel.style.transform = `rotate(${finalAngle}deg)`;
  setTimeout(()=> {
    wheel.style.transition = '';
    wheel.style.transform = `rotate(${finalAngle % 360}deg)`;
    if(success){
      upgradeSelectedItem.price = Math.round(upgradeSelectedItem.price * multiplier);
      upgradeSelectedItem.upgraded = upgradeSelectedItem.upgraded || { times:0, multiplier:1 };
      upgradeSelectedItem.upgraded.times += 1;
      upgradeSelectedItem.upgraded.multiplier *= multiplier;
      document.getElementById('upgradeResultSmall').textContent = `–£—Å–ø–µ—Ö! –ü—Ä–µ–¥–º–µ—Ç —É–º–Ω–æ–∂–µ–Ω –Ω–∞ ${multiplier}x. –ù–æ–≤–∞—è —Ü–µ–Ω–∞: ${upgradeSelectedItem.price} ‚ÇΩ`;
      upgradeSelectedPrice.textContent = `${upgradeSelectedItem.price} ‚ÇΩ`;
      pushFakeChat(`${shortName()} —É—Å–ø–µ—à–Ω–æ –∞–ø–≥—Ä–µ–π–¥–Ω—É–ª ${upgradeSelectedItem.name} –¥–æ ${upgradeSelectedItem.price} ‚ÇΩ`);
    } else {
      document.getElementById('upgradeResultSmall').textContent = '–ù–µ—É–¥–∞—á–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –ø—Ä–æ–¥–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.';
      pushFakeChat(`${shortName()} –Ω–µ—É–¥–∞—á–Ω–æ –∞–ø–≥—Ä–µ–π–¥–Ω—É–ª ${upgradeSelectedItem.name}`);
    }
    renderInventory();
  }, 2050);
}
document.getElementById('upgrade2xBtn').addEventListener('click', ()=> performUpgrade(2));
document.getElementById('upgrade3xBtn').addEventListener('click', ()=> performUpgrade(3));

/* --- Bank handlers --- */
bankBtn.addEventListener('click', ()=> bankOverlay.style.display = 'flex');
closeBank.addEventListener('click', ()=> bankOverlay.style.display = 'none');
depositBtn.addEventListener('click', ()=> {
  showModal('–î–µ–º–æ: –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ. –í —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç ‚Äî 100 ‚ÇΩ.', false);
});
withdrawBtn.addEventListener('click', ()=> {
  const val = Number(amountInput.value) || 0;
  if(val < 500) return showModal('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ ‚Äî 500 ‚ÇΩ', false);
  if(val > state.balance) return showModal('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞', false);
  subBalance(val);
  bankOverlay.style.display = 'none';
  showModal(`–í—ã–≤–µ–¥–µ–Ω–æ ${val} ‚ÇΩ (–¥–µ–º–æ)`, false);
  pushFakeChat(`${shortName()} —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—ã–≤–µ–ª ${val} ‚ÇΩ`);
});

/* --- –ë–æ–Ω—É—Å 10 ‚ÇΩ –≤ –¥–µ–Ω—å (–∞–Ω—Ç–∏–∞–±—É–∑) --- */
function todayKey(){ const d = new Date(); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
bonusBtn.addEventListener('click', ()=>{
  const last = localStorage.getItem('lastBonusDate_' + CURRENT_USER);
  const today = todayKey();
  if(last === today){ bonusMsg.textContent = '–ë–æ–Ω—É—Å —É–∂–µ –ø–æ–ª—É—á–µ–Ω —Å–µ–≥–æ–¥–Ω—è'; setTimeout(()=> bonusMsg.textContent = '', 2500); return; }
  addBalance(10);
  localStorage.setItem('lastBonusDate_' + CURRENT_USER, today);
  bonusMsg.textContent = '–ë–æ–Ω—É—Å 10 ‚ÇΩ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞—á–∏—Å–ª–µ–Ω';
  setTimeout(()=> bonusMsg.textContent = '', 3000);
});

/* --- –ú–æ–¥–∞–ª–∫–∏ --- */
function showModal(text, showWinBox=true){
  // simple modal message in overlay
  const existing = document.getElementById('modalContent');
  if(existing) existing.remove();
  const content = document.createElement('div');
  content.id = 'modalContent';
  content.style.color = '#cbd5e1';
  content.style.padding = '12px';
  content.style.maxWidth = '720px';
  content.innerHTML = text;
  const modal = document.getElementById('modal');
  modal.appendChild(content);
  if(showWinBox) winResultBox.style.display = 'none';
  overlay.style.display = 'flex';
  if(!showWinBox){
    setTimeout(()=> { if(overlay.style.display === 'flex') overlay.style.display = 'none'; content.remove(); }, 2200);
  }
}
overlay.addEventListener('click', (e)=> { if(e.target === overlay) overlay.style.display = 'none'; });
closeModal.addEventListener('click', ()=> overlay.style.display = 'none');

/* --- Fake online & chat feed --- */
let fakeOnline = 120 + Math.floor(Math.random()*80);
function updateFakeOnline(){ fakeOnline += Math.floor(Math.random()*7 - 3); if(fakeOnline < 5) fakeOnline = 5; fakeOnlineEl.textContent = fakeOnline; }
setInterval(updateFakeOnline, 5000);
updateFakeOnline();

const sampleWins = [
  'AK-47 | Redline','AWP | Asiimov','Desert Eagle | Blaze','Glock-18 | Fade',
  'AK-47 | Vulcan','M4A4 | Howl','AWP | Dragon Lore','Sport Gloves | Pandora\'s Box',
  'P90 | Asiimov','CZ75-Auto | Tigris','USP-S | Kill Confirmed'
];
const sampleUsers = ['ivan_92','anna_pro','gamerMax','oleg_cs','vlad99','katya','pro_player','rus_bot'];
function shortName(){ return sampleUsers[Math.floor(Math.random()*sampleUsers.length)]; }
function pushFakeChat(text){
  const el = document.createElement('div'); el.className = 'chatMessage';
  const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = `${shortName()} ‚Ä¢ ${new Date().toLocaleTimeString()}`;
  const body = document.createElement('div'); body.textContent = text;
  el.appendChild(meta); el.appendChild(body);
  chatBox.appendChild(el);
  chatBox.scrollTop = chatBox.scrollHeight;
}
function seedChat(){
  const initial = [
    `${shortName()} –æ—Ç–∫—Ä—ã–ª Dust II Case –∏ –ø–æ–ª—É—á–∏–ª AK-47 | Redline`,
    `${shortName()} –≤—ã–≤–µ–ª 600 ‚ÇΩ`,
    `${shortName()} –æ—Ç–∫—Ä—ã–ª Glove Case –∏ –ø–æ–ª—É—á–∏–ª Sport Gloves | Pandora's Box`,
    `${shortName()} –ø—Ä–æ–¥–∞–ª –ø—Ä–µ–¥–º–µ—Ç –∑–∞ 700 ‚ÇΩ`,
    `${shortName()} –æ—Ç–∫—Ä—ã–ª Inferno Case –∏ –ø–æ–ª—É—á–∏–ª AWP | Asiimov`
  ];
  initial.forEach((m,i)=> setTimeout(()=> pushFakeChat(m), 300*i));
  setInterval(()=> {
    const r = Math.random();
    if(r < 0.6){
      const prize = sampleWins[Math.floor(Math.random()*sampleWins.length)];
      pushFakeChat(`${shortName()} –æ—Ç–∫—Ä—ã–ª –∫–µ–π—Å –∏ –ø–æ–ª—É—á–∏–ª ${prize}`);
    } else {
      const amount = 500 + Math.floor(Math.random()*201);
      pushFakeChat(`${shortName()} —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—ã–≤–µ–ª ${amount} ‚ÇΩ`);
    }
  }, 7000 + Math.random()*8000);
}
seedChat();

/* --- –ê–¥–º–∏–Ω–∫–∞: –ø—Ä–æ—Å—Ç–æ–π –¥–æ—Å—Ç—É–ø –∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è --- */
let adminLogged = false;
adminToggle.addEventListener('click', ()=> {
  adminPanel.style.display = adminPanel.style.display === 'none' ? 'block' : 'none';
});
adminLogin.addEventListener('click', ()=> {
  const pass = adminPass.value || '';
  if(pass === 'admin123'){ // demo password
    adminLogged = true;
    adminControls.style.display = 'block';
    populateAdminSelects();
    showModal('–ê–¥–º–∏–Ω: –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω (–¥–µ–º–æ).', false);
  } else {
    showModal('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å (–¥–µ–º–æ).', false);
  }
});
function populateAdminSelects(){
  adminForceCase.innerHTML = '';
  WORK_CASES.forEach(c => {
    const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; adminForceCase.appendChild(opt);
  });
  adminForceItem.innerHTML = '';
  // fill with all items
  const allItems = WORK_CASES.flatMap(c => c.items);
  allItems.forEach(it => {
    const opt = document.createElement('option'); opt.value = it.id; opt.textContent = it.name; adminForceItem.appendChild(opt);
  });
}
adminAddBtn.addEventListener('click', ()=> {
  if(!adminLogged) return showModal('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É', false);
  const v = Number(adminAddAmount.value) || 0;
  if(v <= 0) return showModal('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É > 0', false);
  addBalance(v);
  showModal(`–ê–¥–º–∏–Ω: –¥–æ–±–∞–≤–ª–µ–Ω–æ ${v} ‚ÇΩ –≤–∞—à–µ–º—É –±–∞–ª–∞–Ω—Å—É (–¥–µ–º–æ)`, false);
});
adminSetRtpBtn.addEventListener('click', ()=> {
  if(!adminLogged) return showModal('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É', false);
  const r = Number(adminSetRtp.value);
  if(!r || r < 0.1 || r > 0.95) return showModal('RTP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0.10‚Äì0.95', false);
  state.currentRtp = r;
  applyHiddenRtp(state.currentRtp);
  showModal(`–ê–¥–º–∏–Ω: RTP —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ${r}`, false);
});
adminForceWin.addEventListener('click', ()=> {
  if(!adminLogged) return showModal('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É', false);
  const caseId = adminForceCase.value;
  const itemId = adminForceItem.value;
  const c = WORK_CASES.find(x=>x.id===caseId);
  if(!c) return showModal('–ö–µ–π—Å –Ω–µ –Ω–∞–π–¥–µ–Ω', false);
  const item = c.items.find(it => it.id === itemId);
  if(!item) return showModal('–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∫–µ–π—Å–µ', false);
  // simulate opening without cost
  const inv = { uid: uid('it'), id: item.id, name: item.name, price: item.price, img: item.img, upgraded: null };
  state.inventory.push(inv);
  renderInventory();
  showFullScreenWin(inv);
  pushFakeChat(`–ê–¥–º–∏–Ω –≤—ã–¥–∞–ª: ${item.name}`);
});
adminClearRef.addEventListener('click', ()=> {
  if(!adminLogged) return showModal('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É', false);
  // clear all ref earnings keys (demo)
  Object.keys(localStorage).forEach(k => { if(k.startsWith('ch_refearn_')) localStorage.removeItem(k); });
  refEarningsEl.textContent = 0;
  showModal('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã (–¥–µ–º–æ).', false);
});

/* --- –°–∫—Ä—ã—Ç–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —à–∞–Ω—Å–æ–≤ (RTP) --- */
function applyHiddenRtp(targetRtp){
  WORK_CASES.forEach(c => {
    const items = c.items;
    const avgPrice = items.reduce((s,i)=>s+i.price,0)/items.length;
    const baseChances = items.map(i => i.baseChance || 1);
    const factor = Math.max(0.10, targetRtp);
    const newChances = items.map((it, idx) => {
      const rel = it.price / avgPrice;
      const val = baseChances[idx] * (1 / (1 + (rel - 1) * (1.4 - factor)));
      return Math.max(val, 0.01);
    });
    items.forEach((it, idx) => it.chance = newChances[idx]);
  });
}

/* --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã --- */
function init(){
  // set referrer if present in URL (only once)
  setLocalReferrerIfNew();
  initReferralUI();
  applyHiddenRtp(state.currentRtp);
  renderCases();
  updateBalanceUI();
  renderInventory();
  try { if(window.TelegramWebApp && window.TelegramWebApp.MainButton) window.TelegramWebApp.MainButton.hide(); } catch(e){}
}
init();

/* --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ: UI –∏ —Ç–µ—Å—Ç—ã --- */
function updateBalanceUI(){ balanceEl.textContent = state.balance; saveBalance(state.balance); refEarningsEl.textContent = getReferralEarningsForMe(); myRefLinkInput.value = getMyRefLink(); }
function uidShort(){ return CURRENT_USER.slice(-6); }

/* --- –§–µ–π–∫–æ–≤—ã–π —á–∞—Ç seed --- */
(function seedChatAuto(){
  const initial = [
    `${shortName()} –æ—Ç–∫—Ä—ã–ª Dust II Case –∏ –ø–æ–ª—É—á–∏–ª AK-47 | Redline`,
    `${shortName()} –≤—ã–≤–µ–ª 600 ‚ÇΩ`,
    `${shortName()} –æ—Ç–∫—Ä—ã–ª Glove Case –∏ –ø–æ–ª—É—á–∏–ª Sport Gloves | Pandora's Box`,
    `${shortName()} –ø—Ä–æ–¥–∞–ª –ø—Ä–µ–¥–º–µ—Ç –∑–∞ 700 ‚ÇΩ`,
    `${shortName()} –æ—Ç–∫—Ä—ã–ª Inferno Case –∏ –ø–æ–ª—É—á–∏–ª AWP | Asiimov`
  ];
  initial.forEach((m,i)=> setTimeout(()=> pushFakeChat(m), 300*i));
})();

/* --- –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è --- */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'b') bonusBtn.click();
});

/* --- –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∏–º—ë–Ω --- */
function shortName(){ return sampleUsers[Math.floor(Math.random()*sampleUsers.length)]; }

/* --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ --- */
refEarningsEl.textContent = getReferralEarningsForMe();

/* --- –ö–æ–Ω–µ—Ü —Å–∫—Ä–∏–ø—Ç–∞ --- */
</script>
</body>
</html>