<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Case Hunters</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
<style>
/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
body{margin:0;font-family:Arial;background:#0b0f14;color:#fff;padding-top:180px;}
#dailyBonusBox{
  position:fixed; top:0;left:0;right:0;
  display:flex; justify-content:center; align-items:center;
  background:rgba(20,20,24,0.96); padding:10px 0 8px 0; z-index:5;
  gap: 15px; flex-direction:column; box-shadow:0 6px 28px rgba(0,0,0,.25); max-height:70px;
}
#topBar{position:fixed;top:70px;left:0;right:0;background:#020617;padding:14px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.6);z-index:20}
#logo{font-family:'Russo One',sans-serif;font-size:22px;color:#facc15}
#balanceBox{padding:8px 14px;border-radius:14px; background:linear-gradient(135deg,#facc15,#eab308);color:#020617;font-weight:bold;box-shadow:0 0 15px rgba(250,204,21,.6)}
#bankBtn{background:#eab308;color:#020617;font-size:26px; border:none;padding:8px 15px;border-radius:13px;margin-left:12px;cursor:pointer;box-shadow:0 0 8px #000a;}
#bankOverlay{display:none;position:fixed;inset:0;z-index:40;justify-content:flex-end;align-items:flex-start;}
#bankModal{margin:110px 30px 0 0;background:#181d27;border-radius:13px;box-shadow:0 4px 32px #000b;padding:22px 32px;display:flex;flex-direction:column;align-items:center;}
#bankOverlay.show{display:flex;}
#bankModal button{background:#facc15;color:#2b230b;border:none;border-radius:10px;padding:10px 26px;font-size:18px;margin:8px 0;font-weight:bold;}
.section{background:#111827;border-radius:16px;padding:14px;margin:12px auto;width:min(96vw,560px)}
.case,.item{display:flex;justify-content:space-between;align-items:center;background:#1f2937; border-radius:12px;padding:10px;margin:8px 0;cursor:pointer;}
.case:hover{background:#374151}
.case img,.item img{width:52px;height:52px;object-fit:cover;border-radius:8px;box-shadow:0 0 6px #0008}
.small{font-size:12px;opacity:.7}
.selected{outline:2px solid #facc15}
.upgrade-candidate{outline:3px solid #38bdf8;}
.roulette{overflow:hidden;position:relative;border:2px solid #facc15;border-radius:14px;height:100px;margin:13px 0;}
.track{display:flex;transform:translateX(0);will-change:transform;}
.roulette-item{width:90px;flex-shrink:0;text-align:center;font-size:11px}
.roulette-item img{width:60px;height:60px;display:block;margin:0 auto 4px;border-radius:8px;box-shadow:0 0 7px #000b;}
.roulette-marker{ position:absolute;top:0;bottom:0;left:50%;width:0; border-left:5px solid #facc15; z-index:9; pointer-events:none; filter:drop-shadow(0 0 8px #facc15) drop-shadow(0 0 8px #facc151a); }
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:90}
#modal{background:#020617;border-radius:18px;padding:16px 0 14px 0;width:min(95vw,520px)}
#winResultBox{ margin-top:20px; padding:20px; background:#1a3a3a; border-radius:14px; border:2px solid #facc15; text-align:center; display:none; animation:winPulse 0.6s ease-in-out; }
@keyframes winPulse{ 0%{transform:scale(0.8);opacity:0;} 50%{transform:scale(1.05);} 100%{transform:scale(1);opacity:1;} }
#winResultBox img{width:80px;height:80px;border-radius:10px;margin:0 auto 10px;box-shadow:0 0 20px #facc15;}
#winResultBox .winTitle{font-size:20px;font-weight:bold;color:#facc15;margin-bottom:5px;}
#winResultBox .winPrice{font-size:16px;color:#4ecdc4;}
.openBtn{background:#10b981;border:none;padding:12px 18px;border-radius:12px;color:#fff;font-weight:bold;font-size:16px;cursor:pointer;box-shadow:0 6px 18px rgba(16,185,129,.12)}
.openBtn:disabled{opacity:.5;cursor:not-allowed}
.footerNote{font-size:12px;color:#9ca3af;text-align:center;margin:18px 0}
input[type="number"]{padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff;width:120px;text-align:center}
.smallBtn{background:#111827;border:1px solid #2b3440;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.hidden{display:none}
.label{font-size:13px;color:#cbd5e1;margin-bottom:6px}
.row{display:flex;gap:8px;align-items:center}
.rtpInfo{font-size:12px;color:#9ca3af;margin-top:6px}
</style>

<!-- –°–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π "–ø–æ—á–∏–Ω–∏—Ç" –≤–Ω–µ—à–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏, –ø–æ–¥—Å—Ç–∞–≤–ª—è—è –ø—Ä–æ–∫—Å–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.
     –≠—Ç–æ –Ω–µ –º–µ–Ω—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–µ URL –≤ –∫–æ–¥–µ ‚Äî –æ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç src —É <img>,
     –∞ —Ç–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å. -->
<script>
(function(){
  function proxifyUrl(url){
    if(!url) return url;
    if(url.startsWith('data:')) return url;
    if(url.includes('images.weserv.nl')) return url;
    try {
      const cleaned = url.replace(/^https?:\/\//i,'');
      return 'https://images.weserv.nl/?url=' + encodeURIComponent(cleaned);
    } catch(e){
      return url;
    }
  }

  function fixImgElement(img){
    try {
      const s = img.getAttribute && img.getAttribute('src');
      if(!s) return;
      if(s.startsWith('data:') || s.includes('images.weserv.nl')) return;
      img.src = proxifyUrl(s);
      img.referrerPolicy = 'no-referrer';
      img.crossOrigin = 'anonymous';
    } catch(e){}
  }

  function fixExistingImgs(){
    document.querySelectorAll('img').forEach(fixImgElement);
  }

  const mo = new MutationObserver(muts=>{
    muts.forEach(m=>{
      m.addedNodes.forEach(node=>{
        if(node.nodeType !== 1) return;
        if(node.tagName === 'IMG') fixImgElement(node);
        node.querySelectorAll && node.querySelectorAll('img').forEach(fixImgElement);
      });
      if(m.type === 'attributes' && m.target && m.target.tagName === 'IMG'){
        fixImgElement(m.target);
      }
    });
  });

  mo.observe(document.documentElement, { childList: true, subtree: true, attributes: true, attributeFilter: ['src'] });

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ fixExistingImgs(); setTimeout(fixExistingImgs, 400); });
  } else {
    fixExistingImgs();
    setTimeout(fixExistingImgs, 400);
  }

  const origInsert = Element.prototype.insertAdjacentHTML;
  Element.prototype.insertAdjacentHTML = function(position, text){
    const res = origInsert.call(this, position, text);
    setTimeout(fixExistingImgs, 50);
    return res;
  };
})();
</script>
</head>
<body>
<div id="dailyBonusBox">
  <button type="button" id="bonusBtn">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å 100 000 ‚ÇΩ</button>
  <div id="bonusMsg"></div>
</div>
<div id="topBar">
  <div id="logo">CASE HUNTERS</div>
  <div style="display:flex;align-items:center;">
    <div id="balanceBox"><span style="font-size:23px;">üíµ</span> <span id="balance">1250</span> ‚ÇΩ</div>
    <button id="bankBtn">üíº</button>
  </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<div style="padding:20px 12px 80px;">
  <div class="section" id="casesSection">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:bold">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–µ–π—Å—ã</div>
      <div class="small">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–µ–π—Å, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
    </div>

    <!-- –ü—Ä–∏–º–µ—Ä –∫–µ–π—Å–æ–≤ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS) -->
    <div id="casesList">
      <!-- –∫–µ–π—Å—ã –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
    </div>
  </div>

  <div class="section" id="openSection">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:bold">–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</div>
      <div class="small">–ë–∞–ª–∞–Ω—Å: <span id="balanceSmall">1250</span> ‚ÇΩ</div>
    </div>

    <div id="selectedCaseBox" style="margin-top:12px;display:flex;gap:12px;align-items:center;">
      <div id="selectedCaseInfo" style="flex:1">
        <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å —Å–ª–µ–≤–∞</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;">
        <div style="margin-bottom:8px">
          <button id="openOnce" class="openBtn" disabled>–û—Ç–∫—Ä—ã—Ç—å 1</button>
        </div>
        <div>
          <button id="openTen" class="openBtn" disabled>–û—Ç–∫—Ä—ã—Ç—å 10</button>
        </div>
      </div>
    </div>

    <div class="roulette" id="roulette" style="margin-top:16px;">
      <div class="track" id="track"></div>
      <div class="roulette-marker"></div>
    </div>

    <div id="openLog" style="margin-top:12px;font-size:13px;opacity:.9"></div>
  </div>

  <div class="section" id="inventorySection">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:bold">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
      <div class="small">–í–∞—à–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</div>
    </div>
    <div id="inventoryList" style="margin-top:12px"></div>
  </div>

  <div class="footerNote">–≠—Ç–æ –¥–µ–º–æ-—Å—Ç—Ä–∞–Ω–∏—Ü–∞. –í—Å–µ —Å—É–º–º—ã —É—Å–ª–æ–≤–Ω—ã–µ.</div>
</div>

<!-- –ë–∞–Ω–∫ / –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ -->
<div id="bankOverlay">
  <div id="bankModal">
    <div style="font-weight:bold;font-size:18px;margin-bottom:8px">–ë–∞–Ω–∫</div>
    <div style="margin-bottom:10px;color:#9ca3af">–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –∏–ª–∏ –≤—ã–≤–µ–¥–∏—Ç–µ —Å—Ä–µ–¥—Å—Ç–≤–∞. –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å RTP (–æ–∂–∏–¥–∞–µ–º—ã–π –≤–æ–∑–≤—Ä–∞—Ç) –¥–ª—è –∫–µ–π—Å–æ–≤.</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
      <input id="amountInput" type="number" min="1" step="50" value="500" />
      <button id="depositBtn" class="smallBtn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
      <button id="withdrawBtn" class="smallBtn">–í—ã–≤–µ—Å—Ç–∏</button>
    </div>

    <div style="width:100%;margin-top:8px;border-top:1px solid #222;padding-top:10px">
      <div class="label">–ì–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ RTP (—Ü–µ–ª–µ–≤–æ–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞):</div>
      <div class="row" style="margin-bottom:8px">
        <input id="rtpInput" type="number" min="0.1" max="5" step="0.01" value="1.00" style="width:100px">
        <button id="applyRtpBtn" class="smallBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å RTP</button>
        <div style="margin-left:8px;color:#9ca3af;font-size:13px">–¢–µ–∫—É—â–∏–π RTP: <span id="currentRtp">1.00</span></div>
      </div>
      <div class="rtpInfo">RTP –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —à–∞–Ω—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–µ–π—Å–æ–≤ ‚Äî —á–µ–º –≤—ã—à–µ RTP, —Ç–µ–º –≤—ã—à–µ —Å—Ä–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—ã –∫–µ–π—Å–∞.</div>
    </div>

    <button id="closeBank" style="background:#111827;color:#fff;border-radius:10px;padding:8px 16px;border:none;cursor:pointer">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- –û–≤–µ—Ä–ª–µ–π –º–æ–¥–∞–ª–∫–∏ -->
<div id="overlay">
  <div id="modal">
    <div style="padding:12px 18px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:bold">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <button id="closeModal" class="smallBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="winResultBox">
        <img id="winImg" src="" alt="win">
        <div class="winTitle" id="winTitle">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏</div>
        <div class="winPrice" id="winPrice">0 ‚ÇΩ</div>
      </div>
      <div id="modalContent" style="margin-top:12px;padding:8px 6px;text-align:center;color:#cbd5e1"></div>
    </div>
  </div>
</div>

<script>
/*
  –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞:
  - –í –∫–µ–π—Å–∞—Ö –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ä—É–∂–∏—è –≤ —Å—Ç–∏–ª–µ CS:GO (—Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ picsum).
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ RTP: –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ RTP –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —à–∞–Ω—Å—ã –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –∫–µ–π—Å–∞,
    —á—Ç–æ–±—ã —Å—Ä–µ–¥–Ω–∏–π –æ–∂–∏–¥–∞–µ–º—ã–π –≤—ã–∏–≥—Ä—ã—à –ø—Ä–∏–±–ª–∏–∂–∞–ª—Å—è –∫ —Ü–µ–Ω–µ * RTP.
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–í—ã–≤–µ—Å—Ç–∏" —Ä—è–¥–æ–º —Å "–ü–æ–ø–æ–ª–Ω–∏—Ç—å".
  - –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.
*/

/* --- –î–∞–Ω–Ω—ã–µ (–¥–µ–º–æ) ---
   –ó–¥–µ—Å—å –∑–∞–º–µ–Ω–µ–Ω—ã –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–∞ –æ—Ä—É–∂–∏–µ/—Å–∫–∏–Ω—ã, –ø–æ—Ö–æ–∂–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º –Ω–∞ CS:GO-—Å—Ç–∏–ª—å.
   –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –±–µ—Ä—É—Ç—Å—è —Å picsum (seed) ‚Äî –ø—Ä–æ–∫—Å–∏-—Å–∫—Ä–∏–ø—Ç –≤—ã—à–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É.
*/
const CASES = [
  { id: 'case1', name: 'Dust II Case', price: 100, img: 'https://picsum.photos/seed/cs_case1/80/80', baseItems: [
    { id:'g1', name:'AK-47 | Redline', price:120, img:'https://picsum.photos/seed/ak_redline/80/80', baseChance: 40 },
    { id:'g2', name:'M4A1-S | Guardian', price:300, img:'https://picsum.photos/seed/m4_guardian/80/80', baseChance: 30 },
    { id:'g3', name:'AWP | Asiimov', price:2500, img:'https://picsum.photos/seed/awp_asiimov/80/80', baseChance: 5 },
    { id:'g4', name:'Desert Eagle | Blaze', price:800, img:'https://picsum.photos/seed/deagle_blaze/80/80', baseChance: 25 }
  ]},
  { id: 'case2', name: 'Inferno Case', price: 500, img: 'https://picsum.photos/seed/cs_case2/80/80', baseItems: [
    { id:'p1', name:'AK-47 | Vulcan', price:1200, img:'https://picsum.photos/seed/ak_vulcan/80/80', baseChance: 35 },
    { id:'p2', name:'M4A4 | Howl', price:8000, img:'https://picsum.photos/seed/m4_howl/80/80', baseChance: 10 },
    { id:'p3', name:'AWP | Dragon Lore', price:50000, img:'https://picsum.photos/seed/awp_dlore/80/80', baseChance: 1 },
    { id:'p4', name:'Glock-18 | Fade', price:1500, img:'https://picsum.photos/seed/glock_fade/80/80', baseChance: 54 }
  ]},
  { id: 'case3', name: 'Mirage Case', price: 2000, img: 'https://picsum.photos/seed/cs_case3/80/80', baseItems: [
    { id:'l1', name:'AK-47 | Fire Serpent', price:20000, img:'https://picsum.photos/seed/ak_serpent/80/80', baseChance: 30 },
    { id:'l2', name:'M4A1-S | Hot Rod', price:12000, img:'https://picsum.photos/seed/m4_hotrod/80/80', baseChance: 50 },
    { id:'l3', name:'AWP | Medusa', price:90000, img:'https://picsum.photos/seed/awp_medusa/80/80', baseChance: 20 }
  ]}
];

// –ö–æ–ø–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã (items –±—É–¥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–∫—É—â–∏–µ —à–∞–Ω—Å—ã)
const WORK_CASES = CASES.map(c => {
  const items = c.baseItems.map(it => ({ ...it, chance: it.baseChance }));
  return { ...c, items, baseTotalChance: items.reduce((s,i)=>s+i.baseChance,0) };
});

let state = {
  balance: 1250,
  selectedCase: null,
  inventory: [],
  lastWin: null,
  bonusTaken: false,
  currentRtp: 1.00 // –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ü–µ–ª–µ–≤–æ–π RTP
};

/* --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM --- */
const balanceEl = document.getElementById('balance');
const balanceSmallEl = document.getElementById('balanceSmall');
const casesListEl = document.getElementById('casesList');
const selectedCaseInfoEl = document.getElementById('selectedCaseInfo');
const openOnceBtn = document.getElementById('openOnce');
const openTenBtn = document.getElementById('openTen');
const rouletteTrack = document.getElementById('track');
const rouletteEl = document.getElementById('roulette');
const openLogEl = document.getElementById('openLog');
const inventoryListEl = document.getElementById('inventoryList');
const bankBtn = document.getElementById('bankBtn');
const bankOverlay = document.getElementById('bankOverlay');
const closeBank = document.getElementById('closeBank');
const depositBtn = document.getElementById('depositBtn');
const withdrawBtn = document.getElementById('withdrawBtn');
const amountInput = document.getElementById('amountInput');
const overlay = document.getElementById('overlay');
const winResultBox = document.getElementById('winResultBox');
const winImg = document.getElementById('winImg');
const winTitle = document.getElementById('winTitle');
const winPrice = document.getElementById('winPrice');
const closeModal = document.getElementById('closeModal');
const bonusBtn = document.getElementById('bonusBtn');
const bonusMsg = document.getElementById('bonusMsg');
const rtpInput = document.getElementById('rtpInput');
const applyRtpBtn = document.getElementById('applyRtpBtn');
const currentRtpEl = document.getElementById('currentRtp');

/* --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI --- */
function renderCases(){
  casesListEl.innerHTML = '';
  WORK_CASES.forEach(c => {
    const el = document.createElement('div');
    el.className = 'case';
    el.dataset.id = c.id;
    const ev = computeCaseEV(c);
    const rtp = (ev / c.price).toFixed(3);
    el.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${c.img}" alt="${c.name}">
        <div>
          <div style="font-weight:bold">${c.name}</div>
          <div class="small">–¶–µ–Ω–∞: ${c.price} ‚ÇΩ ‚Ä¢ EV: ${Math.round(ev)} ‚ÇΩ ‚Ä¢ RTP: ${rtp}</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end">
        <div class="small">–ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${c.items.length}</div>
        <div style="margin-top:6px"><button class="smallBtn" data-open="${c.id}">–û—Ç–∫—Ä—ã—Ç—å</button></div>
      </div>
    `;
    el.addEventListener('click', (e)=>{
      if(e.target && e.target.dataset && e.target.dataset.open) return;
      selectCase(c.id);
    });
    const openBtn = el.querySelector('button[data-open]');
    openBtn.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      selectCase(c.id);
      openCase(1);
    });
    casesListEl.appendChild(el);
  });
}

function updateBalanceUI(){
  balanceEl.textContent = state.balance;
  balanceSmallEl.textContent = state.balance;
}

/* --- –í—ã–±–æ—Ä –∫–µ–π—Å–∞ --- */
function selectCase(caseId){
  const c = WORK_CASES.find(x=>x.id===caseId);
  state.selectedCase = c;
  document.querySelectorAll('.case').forEach(el=>{
    el.classList.toggle('selected', el.dataset.id === caseId);
  });
  const ev = computeCaseEV(c);
  const rtp = (ev / c.price).toFixed(3);
  selectedCaseInfoEl.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <img src="${c.img}" style="width:64px;height:64px;border-radius:10px">
      <div>
        <div style="font-weight:bold">${c.name}</div>
        <div class="small">–¶–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è: ${c.price} ‚ÇΩ</div>
        <div class="small">–ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${c.items.length}</div>
        <div class="small">EV: ${Math.round(ev)} ‚ÇΩ ‚Ä¢ RTP: ${rtp}</div>
      </div>
    </div>
  `;
  openOnceBtn.disabled = false;
  openTenBtn.disabled = false;
  prepareRoulette(c);
}

/* --- –†—É–ª–µ—Ç–∫–∞ --- */
function prepareRoulette(c){
  rouletteTrack.innerHTML = '';
  const items = [];
  for(let i=0;i<30;i++){
    c.items.forEach(it => items.push(it));
  }
  items.forEach(it=>{
    const el = document.createElement('div');
    el.className = 'roulette-item';
    el.innerHTML = `<img src="${it.img}" alt="${it.name}"><div>${it.name}</div><div class="small">${it.price} ‚ÇΩ</div>`;
    rouletteTrack.appendChild(el);
  });
  rouletteTrack.style.transform = 'translateX(0)';
}

/* --- –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞ --- */
function openCase(count=1){
  if(!state.selectedCase) return;
  const totalCost = state.selectedCase.price * count;
  if(state.balance < totalCost){
    showModal(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ ${totalCost} ‚ÇΩ`, false);
    return;
  }
  state.balance -= totalCost;
  updateBalanceUI();

  const results = [];
  let seq = Promise.resolve();
  for(let i=0;i<count;i++){
    seq = seq.then(()=> new Promise(res=>{
      const win = pickRandomItem(state.selectedCase.items);
      results.push(win);
      animateRouletteTo(win).then(()=> {
        state.inventory.push(win);
        state.lastWin = win;
        showWin(win);
        res();
      });
    }));
  }
  seq.then(()=>{
    renderInventory();
    logOpen(results);
  });
}

/* --- –í—ã–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞ –ø–æ —à–∞–Ω—Å–∞–º --- */
function pickRandomItem(items){
  const total = items.reduce((s,it)=>s + (it.chance || 1),0);
  let r = Math.random()*total;
  for(const it of items){
    r -= (it.chance || 1);
    if(r <= 0) return JSON.parse(JSON.stringify(it));
  }
  return JSON.parse(JSON.stringify(items[items.length-1]));
}

/* --- –ê–Ω–∏–º–∞—Ü–∏—è —Ä—É–ª–µ—Ç–∫–∏ --- */
function animateRouletteTo(item){
  return new Promise(res=>{
    const nodes = Array.from(rouletteTrack.children);
    let targetIndex = nodes.findIndex(n => n.textContent.includes(item.name));
    if(targetIndex === -1) targetIndex = Math.floor(nodes.length/2);
    const itemWidth = nodes[0].offsetWidth || 90;
    const visibleWidth = rouletteEl.offsetWidth || 300;
    const centerOffset = Math.floor(visibleWidth/2);
    const targetCenter = targetIndex * itemWidth + itemWidth/2;
    const translateX = centerOffset - targetCenter;
    const duration = 1600 + Math.random()*800;
    rouletteTrack.style.transition = `transform ${duration}ms cubic-bezier(.2,.9,.2,1)`;
    requestAnimationFrame(()=> {
      rouletteTrack.style.transform = `translateX(${translateX}px)`;
    });
    setTimeout(()=>{
      rouletteTrack.style.transition = '';
      res();
    }, duration + 50);
  });
}

/* --- –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ --- */
function showWin(win){
  winImg.src = win.img;
  winTitle.textContent = win.name;
  winPrice.textContent = `${win.price} ‚ÇΩ`;
  winResultBox.style.display = 'block';
  overlay.style.display = 'flex';
  setTimeout(()=> {
    winResultBox.style.display = 'none';
  }, 2500);
}

/* --- –õ–æ–≥ –æ—Ç–∫—Ä—ã—Ç–∏—è --- */
function logOpen(results){
  const lines = results.map(r=>`–í—ã –ø–æ–ª—É—á–∏–ª–∏: <b>${r.name}</b> ‚Äî ${r.price} ‚ÇΩ`).join('<br>');
  openLogEl.innerHTML = lines;
}

/* --- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å --- */
function renderInventory(){
  inventoryListEl.innerHTML = '';
  if(state.inventory.length === 0){
    inventoryListEl.innerHTML = '<div class="small">–ü—É—Å—Ç–æ</div>';
    return;
  }
  state.inventory.slice().reverse().forEach(it=>{
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${it.img}" alt="${it.name}">
        <div>
          <div style="font-weight:bold">${it.name}</div>
          <div class="small">${it.price} ‚ÇΩ</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end">
        <button class="smallBtn" data-sell="${it.name}">–ü—Ä–æ–¥–∞—Ç—å</button>
      </div>
    `;
    const sellBtn = el.querySelector('button[data-sell]');
    sellBtn.addEventListener('click', ()=>{
      state.balance += it.price;
      const idx = state.inventory.findIndex(x=>x.name === it.name);
      if(idx !== -1) state.inventory.splice(idx,1);
      updateBalanceUI();
      renderInventory();
    });
    inventoryListEl.appendChild(el);
  });
}

/* --- –ú–æ–¥–∞–ª–∫–∏ –∏ –±–∞–Ω–∫ --- */
bankBtn.addEventListener('click', ()=> {
  bankOverlay.classList.add('show');
});
closeBank.addEventListener('click', ()=> {
  bankOverlay.classList.remove('show');
});
depositBtn.addEventListener('click', ()=> {
  const val = Number(amountInput.value) || 0;
  if(val <= 0) return;
  state.balance += val;
  updateBalanceUI();
  bankOverlay.classList.remove('show');
});
withdrawBtn.addEventListener('click', ()=> {
  const val = Number(amountInput.value) || 0;
  if(val <= 0) return showModal('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –≤—ã–≤–æ–¥–∞', false);
  if(val > state.balance) return showModal('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞', false);
  state.balance -= val;
  updateBalanceUI();
  bankOverlay.classList.remove('show');
  showModal(`–í—ã–≤–µ–¥–µ–Ω–æ ${val} ‚ÇΩ`, false);
});

/* --- RTP: –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ --- */
/*
  –ü–æ–¥—Ö–æ–¥:
  - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–µ–π—Å–∞ –µ—Å—Ç—å –Ω–∞–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤ —Å —Ü–µ–Ω–∞–º–∏ –∏ –±–∞–∑–æ–≤—ã–º–∏ —à–∞–Ω—Å–∞–º–∏ (baseChance).
  - –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–π EV = sum(price_i * (chance_i / totalChance)).
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞—ë—Ç —Ü–µ–ª–µ–≤–æ–π RTP (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.05 = 105%).
  - –ú—ã —Ö–æ—Ç–∏–º —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–Ω—Å—ã —Ç–∞–∫, —á—Ç–æ–±—ã EV' ‚âà price * RTP.
  - –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä k, –∫–æ—Ç–æ—Ä—ã–π —É—Å–∏–ª–∏–≤–∞–µ—Ç —à–∞–Ω—Å—ã –¥–æ—Ä–æ–≥–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤:
      newChance_i = baseChance_i * (1 + k * (price_i / avgPrice - 1))
    –∏ –∏—â–µ–º k –º–µ—Ç–æ–¥–æ–º –±–∏–Ω–∞—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞, —á—Ç–æ–±—ã EV' –¥–æ—Å—Ç–∏–≥ —Ü–µ–ª–µ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.
  - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: newChance_i >= 0.1 (–º–∏–Ω–∏–º—É–º), k –≤ —Ä–∞–∑—É–º–Ω—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö.
*/
function computeCaseEV(caseObj){
  const total = caseObj.items.reduce((s,it)=>s + (it.chance || 0),0);
  if(total <= 0) return 0;
  return caseObj.items.reduce((s,it)=> s + it.price * ((it.chance || 0)/total), 0);
}

function applyGlobalRtp(targetRtp){
  // –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ –∫–∞–∂–¥–æ–º—É –∫–µ–π—Å—É
  WORK_CASES.forEach(c => {
    adjustCaseRtp(c, targetRtp);
  });
  state.currentRtp = targetRtp;
  currentRtpEl.textContent = targetRtp.toFixed(2);
  renderCases();
  if(state.selectedCase) selectCase(state.selectedCase.id);
}

function adjustCaseRtp(caseObj, targetRtp){
  // –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
  const items = caseObj.items;
  const avgPrice = items.reduce((s,i)=>s+i.price,0)/items.length;
  const baseChances = items.map(i => i.baseChance || 1);

  // —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ k –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç EV
  function evForK(k){
    const newChances = items.map((it, idx) => {
      const val = (baseChances[idx] * (1 + k * (it.price / avgPrice - 1)));
      return Math.max(val, 0.01); // –º–∏–Ω–∏–º—É–º
    });
    const total = newChances.reduce((s,v)=>s+v,0);
    return items.reduce((s,it,idx)=> s + it.price * (newChances[idx]/total), 0);
  }

  // —Ü–µ–ª–µ–≤–æ–π EV
  const targetEV = caseObj.price * targetRtp;

  // –±–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ k
  let low = -0.99, high = 10, mid;
  let evLow = evForK(low), evHigh = evForK(high);
  // –µ—Å–ª–∏ –¥–∞–∂–µ –ø—Ä–∏ high EV –º–µ–Ω—å—à–µ target, –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω–∏–º high
  if(evHigh < targetEV){
    mid = high;
  } else {
    for(let iter=0; iter<40; iter++){
      mid = (low + high)/2;
      const evMid = evForK(mid);
      if(evMid < targetEV) low = mid; else high = mid;
    }
  }
  // –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π k
  const k = mid;
  const newChances = items.map((it, idx) => {
    const val = (baseChances[idx] * (1 + k * (it.price / avgPrice - 1)));
    return Math.max(val, 0.01);
  });
  // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ caseObj.items[].chance
  const total = newChances.reduce((s,v)=>s+v,0);
  items.forEach((it, idx) => {
    it.chance = newChances[idx]; // —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –≤–µ—Å
  });
}

/* --- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ RTP –ø–æ –∫–Ω–æ–ø–∫–µ --- */
applyRtpBtn.addEventListener('click', ()=>{
  const val = Number(rtpInput.value) || 1.0;
  if(val <= 0) return showModal('RTP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º', false);
  applyGlobalRtp(val);
  showModal(`RTP –ø—Ä–∏–º–µ–Ω—ë–Ω: ${val.toFixed(2)}`, false);
});

/* --- –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ --- */
openOnceBtn.addEventListener('click', ()=> openCase(1));
openTenBtn.addEventListener('click', ()=> openCase(10));

/* --- –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ --- */
closeModal.addEventListener('click', ()=> {
  overlay.style.display = 'none';
});

/* --- –ë–æ–Ω—É—Å --- */
bonusBtn.addEventListener('click', ()=>{
  if(state.bonusTaken){
    bonusMsg.textContent = '–ë–æ–Ω—É—Å —É–∂–µ –ø–æ–ª—É—á–µ–Ω —Å–µ–≥–æ–¥–Ω—è';
    return;
  }
  state.balance += 100000;
  state.bonusTaken = true;
  updateBalanceUI();
  bonusMsg.textContent = '–ë–æ–Ω—É—Å –∑–∞—á–∏—Å–ª–µ–Ω!';
  setTimeout(()=> bonusMsg.textContent = '', 3000);
});

/* --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã --- */
function init(){
  // —Å–∫–æ–ø–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ —à–∞–Ω—Å—ã –≤ —Ä–∞–±–æ—á–∏–µ items (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ WORK_CASES)
  renderCases();
  updateBalanceUI();
  renderInventory();
  currentRtpEl.textContent = state.currentRtp.toFixed(2);

  try {
    if(window.TelegramWebApp){
      const tg = window.TelegramWebApp;
      if(tg.MainButton){
        tg.MainButton.hide();
      }
    }
  } catch(e){}
}
init();

/* --- –£—Ç–∏–ª–∏—Ç—ã --- */
function showModal(text, showWinBox=true){
  document.getElementById('modalContent').innerHTML = text;
  if(showWinBox){
    winResultBox.style.display = 'none';
  }
  overlay.style.display = 'flex';
}

/* --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è --- */
overlay.addEventListener('click', (e)=>{
  if(e.target === overlay){
    overlay.style.display = 'none';
  }
});

/* --- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∞–≤–∏—à (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) --- */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'b'){ bonusBtn.click();
  } else if(e.key === 'o'){ if(!openOnceBtn.disabled) openOnceBtn.click();
  } else if(e.key === '1'){ selectCase(WORK_CASES[0].id);
  }
});
</script>
</body>
</html>
