<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>Case Hunters ‚Äî CS:GO Style (Demo)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f14;
  --card:#111827;
  --accent:#facc15;
  --muted:#9ca3af;
  --green:#10b981;
  --yellow-line: #facc15;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue";background:var(--bg);color:#fff;padding-top:180px}
#dailyBonusBox{position:fixed;top:0;left:0;right:0;display:flex;justify-content:center;align-items:center;background:rgba(20,20,24,0.96);padding:10px 0 8px 0;z-index:5;gap:15px;flex-direction:column;box-shadow:0 6px 28px rgba(0,0,0,.25);max-height:70px}
#topBar{position:fixed;top:70px;left:0;right:0;background:#020617;padding:14px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.6);z-index:20}
#logo{font-family:'Russo One',sans-serif;font-size:22px;color:var(--accent)}
#balanceBox{padding:8px 14px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#eab308);color:#020617;font-weight:bold;box-shadow:0 0 15px rgba(250,204,21,.6)}
.small{font-size:12px;opacity:.85;color:#d1d5db}
.section{background:var(--card);border-radius:16px;padding:14px;margin:12px auto;width:min(96vw,760px)}
.case,.item{display:flex;justify-content:space-between;align-items:center;background:#1f2937;border-radius:12px;padding:10px;margin:8px 0;cursor:pointer}
.case:hover{background:#374151}
.case .left, .item .left{display:flex;gap:12px;align-items:center}
.case .meta, .item .meta{display:flex;flex-direction:column}
.case .meta .title, .item .meta .title{font-weight:bold}
.case .meta .sub, .item .meta .sub{font-size:12px;color:var(--muted)}
.smallBtn{background:#111827;border:1px solid #2b3440;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.openBtn{background:var(--green);border:none;padding:12px 18px;border-radius:12px;color:#fff;font-weight:bold;font-size:16px;cursor:pointer}
.openBtn:disabled{opacity:.5;cursor:not-allowed}
.weapon-img{width:64px;height:64px;border-radius:8px;object-fit:cover;box-shadow:0 0 8px #0008;background:#0b0f14;display:block}
.case-badge{width:64px;height:64px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#facc15,#eab308);color:#000;font-weight:900;font-family:'Russo One',sans-serif;box-shadow:0 6px 18px rgba(250,204,21,.18);font-size:14px;letter-spacing:1px;position:relative}
.case-badge .label{transform:translateY(1px)}
.roulette{overflow:hidden;position:relative;border:2px solid var(--accent);border-radius:14px;height:100px;margin:13px 0;background:linear-gradient(180deg,#071018, #071018);width:100%}
.track{display:flex;transform:translateX(0);will-change:transform}
.roulette-item{width:90px;flex-shrink:0;text-align:center;font-size:11px;padding:6px}
.roulette-item img{width:60px;height:60px;display:block;margin:0 auto 4px;border-radius:8px;box-shadow:0 0 7px #000b}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:90}
#modal{background:#020617;border-radius:18px;padding:16px 0 14px 0;width:min(95vw,720px)}
#winResultBox{margin-top:20px;padding:20px;background:#1a3a3a;border-radius:14px;border:2px solid var(--accent);text-align:center;display:none;animation:winPulse 0.6s ease-in-out}
@keyframes winPulse{0%{transform:scale(.8);opacity:0}50%{transform:scale(1.05)}100%{transform:scale(1);opacity:1}}
#winResultBox img{width:80px;height:80px;border-radius:10px;margin:0 auto 10px;box-shadow:0 0 20px var(--accent)}
#winResultBox .winTitle{font-size:20px;font-weight:bold;color:var(--accent);margin-bottom:5px}
#winResultBox .winPrice{font-size:16px;color:#4ecdc4}

/* Upgrade panel fixed at bottom with yellow top line */
#upgradePanel{
  position:fixed;left:0;right:0;bottom:0;background:#071018;border-top:6px solid var(--yellow-line);padding:12px 18px;z-index:80;
  display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;
}
#upgradePanel .panel-inner{max-width:980px;width:100%;display:flex;gap:12px;align-items:center;justify-content:space-between}
#upgradePanel .left{display:flex;gap:12px;align-items:center}
#upgradePanel .small{color:#cbd5e1}
.upgrade-wheel{width:180px;height:180px;border-radius:50%;position:relative;margin:0;background:conic-gradient(#0b1220 0 25%, #071018 25% 50%, #0b1220 50% 75%, #071018 75% 100%);box-shadow:0 8px 40px rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;overflow:hidden}
.upgrade-wheel .pointer{position:absolute;top:6px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:12px solid var(--accent);z-index:20}
.upgrade-wheel .inner{width:60%;height:60%;border-radius:50%;background:rgba(2,6,11,.8);display:flex;align-items:center;justify-content:center;flex-direction:column;color:#cbd5e1;font-size:13px;text-align:center;padding:6px}

/* responsive */
@media (max-width:640px){
  #upgradePanel .panel-inner{flex-direction:column;align-items:center}
  .roulette-item{width:80px}
}
.referral{margin-top:18px;text-align:center;color:#cbd5e1;font-size:13px}
.referral a{color:var(--accent);text-decoration:none;font-weight:bold}
</style>
</head>
<body>
<div id="dailyBonusBox">
  <button type="button" id="bonusBtn">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å 10 ‚ÇΩ</button>
  <div id="bonusMsg"></div>
</div>

<div id="topBar">
  <div id="logo">CASE HUNTERS</div>
  <div style="display:flex;align-items:center;">
    <div id="balanceBox"><span style="font-size:23px;">üíµ</span> <span id="balance">1250</span> ‚ÇΩ</div>
    <button id="bankBtn" class="smallBtn" style="margin-left:12px">üíº</button>
  </div>
</div>

<div style="padding:20px 12px 260px;">
  <div class="section" id="casesSection">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:bold">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–µ–π—Å—ã</div>
      <div class="small">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–µ–π—Å, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
    </div>
    <div id="casesList"></div>
  </div>

  <div class="section" id="inventorySection">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:bold">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
      <div class="small">–í–∞—à–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</div>
    </div>
    <div id="inventoryList" style="margin-top:12px"></div>
  </div>

  <div class="footerNote">–î–µ–º–æ-—Å—Ç—Ä–∞–Ω–∏—Ü–∞: —Ä–µ–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –ª–µ–≥–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –ø–æ–ª–æ–∂–∏—Ç–µ –∏—Ö –≤ –ø–∞–ø–∫—É <code>/assets/cs/</code> –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ CDN.</div>

  <div class="referral">
    –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã ‚Äî –±–æ—Ç –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: <a href="https://t.me/casehunters_bot" target="_blank">@casehunters_bot</a>
  </div>
</div>

<!-- –ë–∞–Ω–∫ / –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ / –≤—ã–≤–æ–¥ (–¥–µ–º–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ) -->
<div id="bankOverlay" style="display:none;position:fixed;inset:0;z-index:40;justify-content:flex-end;align-items:flex-start;">
  <div id="bankModal" style="margin:110px 30px 0 0;background:#181d27;border-radius:13px;box-shadow:0 4px 32px #000b;padding:22px 32px;display:flex;flex-direction:column;align-items:center;">
    <div style="font-weight:bold;font-size:18px;margin-bottom:8px">–ë–∞–Ω–∫ (–¥–µ–º–æ)</div>
    <div style="margin-bottom:10px;color:#9ca3af">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç –≤ —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏ ‚Äî 100 ‚ÇΩ. –í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –æ—Ç 500 ‚ÇΩ.</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
      <input id="amountInput" type="number" min="100" step="50" value="500" />
      <button id="depositBtn" class="smallBtn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å (–¥–µ–º–æ)</button>
      <button id="withdrawBtn" class="smallBtn">–í—ã–≤–µ—Å—Ç–∏</button>
    </div>
    <div style="width:100%;margin-top:8px;border-top:1px solid #222;padding-top:10px">
      <div class="label">RTP –∏ —Ç–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ.</div>
      <div class="rtpInfo">–í —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏ RTP –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º; –≤ –¥–µ–º–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ.</div>
    </div>
    <button id="closeBank" style="background:#111827;color:#fff;border-radius:10px;padding:8px 16px;border:none;cursor:pointer;margin-top:12px">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- –û–≤–µ—Ä–ª–µ–π –º–æ–¥–∞–ª–∫–∏ -->
<div id="overlay">
  <div id="modal">
    <div style="padding:12px 18px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:bold">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <button id="closeModal" class="smallBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div id="winResultBox">
        <img id="winImg" src="" alt="win">
        <div class="winTitle" id="winTitle">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏</div>
        <div class="winPrice" id="winPrice">0 ‚ÇΩ</div>
      </div>

      <div id="modalContent" style="margin-top:12px;padding:8px 6px;text-align:center;color:#cbd5e1"></div>
    </div>
  </div>
</div>

<!-- Upgrade panel fixed at bottom -->
<div id="upgradePanel" aria-hidden="false">
  <div class="panel-inner">
    <div class="left">
      <div style="display:flex;gap:12px;align-items:center">
        <div id="upgradeSelectedPreview" style="width:64px;height:64px;border-radius:8px;background:#0b0f14;display:flex;align-items:center;justify-content:center;color:#cbd5e1">‚Äî</div>
        <div>
          <div id="upgradeSelectedName" style="font-weight:bold">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞</div>
          <div class="small" id="upgradeSelectedPrice">‚Äî</div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <div class="upgrade-wheel" id="upgradeWheelSmall">
        <div class="pointer"></div>
        <div class="inner" id="upgradeInnerSmall">–ê–ø–≥—Ä–µ–π–¥</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div style="display:flex;gap:8px">
          <button id="upgrade2xBtn" class="spin-btn">–ü–æ–ø—ã—Ç–∫–∞ 2x</button>
          <button id="upgrade3xBtn" class="spin-btn">–ü–æ–ø—ã—Ç–∫–∞ 3x</button>
        </div>
        <div id="upgradeResultSmall" class="small" style="min-width:220px;text-align:right"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π --- */
const IMAGE_BASE = '/assets/cs/'; // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à CDN/–ø—É—Ç—å —Å –ª–µ–≥–∞–ª—å–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
function imgPath(name){ return IMAGE_BASE + name; }

/* --- –ö–µ–π—Å—ã —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏, –¥–æ–±–∞–≤–ª–µ–Ω –∫–µ–π—Å —Å –ø–µ—Ä—á–∞—Ç–∫–∞–º–∏ (gloves) --- */
const BASE_CASES = [
  { id:'case0', name:'Starter Case', price:50, imgBadge:true, baseItems:[
    { id:'s1', name:'P250 | Sand Dune', price:35, img: imgPath('p250_sanddune.png'), baseChance:60 },
    { id:'s2', name:'USP-S | Torque', price:90, img: imgPath('usp_torque.png'), baseChance:30 },
    { id:'s3', name:'Nova | Ranger', price:300, img: imgPath('nova_ranger.png'), baseChance:10 }
  ]},
  { id:'case1', name:'Dust II Case', price:90, imgBadge:true, baseItems:[
    { id:'g1', name:'AK-47 | Redline', price:100, img: imgPath('ak_redline.png'), baseChance:45 },
    { id:'g2', name:'M4A1-S | Guardian', price:240, img: imgPath('m4_guardian.png'), baseChance:35 },
    { id:'g3', name:'Desert Eagle | Blaze', price:650, img: imgPath('deagle_blaze.png'), baseChance:20 }
  ]},
  { id:'case1b', name:'Classic Case', price:180, imgBadge:true, baseItems:[
    { id:'c1', name:'AK-47 | Vulcan', price:900, img: imgPath('ak_vulcan.png'), baseChance:40 },
    { id:'c2', name:'M4A4 | Howl', price:5000, img: imgPath('m4_howl.png'), baseChance:8 },
    { id:'c3', name:'Glock-18 | Fade', price:1200, img: imgPath('glock_fade.png'), baseChance:52 }
  ]},
  { id:'case2', name:'Inferno Case', price:450, imgBadge:true, baseItems:[
    { id:'p1', name:'AWP | Asiimov', price:2200, img: imgPath('awp_asiimov.png'), baseChance:20 },
    { id:'p2', name:'AK-47 | Fire Serpent', price:9000, img: imgPath('ak_serpent.png'), baseChance:30 },
    { id:'p3', name:'M4A1-S | Hot Rod', price:7000, img: imgPath('m4_hotrod.png'), baseChance:50 }
  ]},
  { id:'case3', name:'Mirage Case', price:1800, imgBadge:true, baseItems:[
    { id:'l1', name:'AWP | Medusa', price:60000, img: imgPath('awp_medusa.png'), baseChance:5 },
    { id:'l2', name:'AK-47 | Fire Serpent (StatTrak)', price:25000, img: imgPath('ak_serpent_st.png'), baseChance:25 },
    { id:'l3', name:'M4A4 | Howl (StatTrak)', price:12000, img: imgPath('m4_howl_st.png'), baseChance:70 }
  ]},
  // –Ω–æ–≤—ã–π –∫–µ–π—Å —Å –ø–µ—Ä—á–∞—Ç–∫–∞–º–∏, —Ü–µ–Ω–∞ –∫–µ–π—Å–∞ 300
  { id:'gloveCase', name:'Glove Case', price:300, imgBadge:true, baseItems:[
    { id:'gl1', name:'Sport Gloves | Pandora\'s Box', price:12000, img: imgPath('gloves_pandora.png'), baseChance:40 },
    { id:'gl2', name:'Driver Gloves | King Snake', price:25000, img: imgPath('gloves_kingsnake.png'), baseChance:35 },
    { id:'gl3', name:'Specialist Gloves | Crimson Kimono', price:45000, img: imgPath('gloves_crimson.png'), baseChance:25 }
  ]}
];

/* --- –†–∞–±–æ—á–∏–µ –∫–µ–π—Å—ã (–∫–æ–ø–∏–∏) --- */
const WORK_CASES = BASE_CASES.map(c => {
  const items = c.baseItems.map(it => ({ ...it, chance: it.baseChance }));
  return { ...c, items, baseTotalChance: items.reduce((s,i)=>s+i.baseChance,0) };
});

/* --- –°–æ—Å—Ç–æ—è–Ω–∏–µ --- */
let state = {
  balance: 1250,
  selectedCaseId: null,
  inventory: [],
  currentRtp: 0.70
};

/* --- DOM --- */
const balanceEl = document.getElementById('balance');
const balanceSmallEl = document.getElementById('balanceSmall');
const casesListEl = document.getElementById('casesList');
const selectedCaseInfoEl = document.getElementById('selectedCaseInfo');
const openOnceBtn = document.getElementById('openOnce');
const openTenBtn = document.getElementById('openTen');
const openLogEl = document.getElementById('openLog');
const inventoryListEl = document.getElementById('inventoryList');
const bankBtn = document.getElementById('bankBtn');
const bankOverlay = document.getElementById('bankOverlay');
const closeBank = document.getElementById('closeBank');
const depositBtn = document.getElementById('depositBtn');
const withdrawBtn = document.getElementById('withdrawBtn');
const amountInput = document.getElementById('amountInput');
const overlay = document.getElementById('overlay');
const winResultBox = document.getElementById('winResultBox');
const winImg = document.getElementById('winImg');
const winTitle = document.getElementById('winTitle');
const winPrice = document.getElementById('winPrice');
const closeModal = document.getElementById('closeModal');
const bonusBtn = document.getElementById('bonusBtn');
const bonusMsg = document.getElementById('bonusMsg');

/* Upgrade panel elements */
const upgradeSelectedPreview = document.getElementById('upgradeSelectedPreview');
const upgradeSelectedName = document.getElementById('upgradeSelectedName');
const upgradeSelectedPrice = document.getElementById('upgradeSelectedPrice');
const upgrade2xBtn = document.getElementById('upgrade2xBtn');
const upgrade3xBtn = document.getElementById('upgrade3xBtn');
const upgradeResultSmall = document.getElementById('upgradeResultSmall');
const upgradeInnerSmall = document.getElementById('upgradeInnerSmall');

/* --- Utilities --- */
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
function updateBalanceUI(){ balanceEl.textContent = state.balance; balanceSmallEl.textContent = state.balance; }

/* --- Placeholder SVG generator (–µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞) --- */
function placeholderDataUrl(name){
  const w = 256, h = 256;
  const bg = '#0b0f14';
  const accent = '#facc15';
  const text = name.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'>
    <rect width='100%' height='100%' fill='${bg}'/>
    <rect x='12' y='12' width='${w-24}' height='${h-24}' rx='16' fill='${accent}' opacity='0.12'/>
    <text x='50%' y='50%' font-family='Arial, sans-serif' font-size='18' fill='#e6eef6' text-anchor='middle' dominant-baseline='middle'>${text}</text>
  </svg>`;
  return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
}
function safeSetImg(imgEl, src, name){
  imgEl.src = src;
  imgEl.onerror = function(){ imgEl.onerror = null; imgEl.src = placeholderDataUrl(name); };
}

/* --- Render cases: each case contains its own roulette block --- */
function renderCases(){
  casesListEl.innerHTML = '';
  WORK_CASES.forEach(c => {
    const el = document.createElement('div'); el.className = 'case'; el.dataset.id = c.id;

    const left = document.createElement('div'); left.className = 'left';
    const badge = document.createElement('div'); badge.className = 'case-badge'; badge.innerHTML = `<div class="label">–ö–ï–ô–°</div>`;
    left.appendChild(badge);

    const meta = document.createElement('div'); meta.className = 'meta';
    meta.innerHTML = `<div class="title">${c.name}</div><div class="sub">–¶–µ–Ω–∞: ${c.price} ‚ÇΩ</div>`;
    left.appendChild(meta);

    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
    right.innerHTML = `<div class="small">–ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${c.items.length}</div><div style="margin-top:6px"><button class="smallBtn" data-open="${c.id}">–û—Ç–∫—Ä—ã—Ç—å</button></div>`;

    // roulette container inside the case
    const rouletteWrap = document.createElement('div');
    rouletteWrap.className = 'roulette';
    rouletteWrap.style.marginTop = '12px';
    rouletteWrap.style.display = 'none'; // hidden until case selected/opened
    const track = document.createElement('div'); track.className = 'track';
    rouletteWrap.appendChild(track);

    el.appendChild(left);
    // place roulette below left/meta inside a column layout
    const centerCol = document.createElement('div');
    centerCol.style.flex = '1';
    centerCol.style.display = 'flex';
    centerCol.style.flexDirection = 'column';
    centerCol.appendChild(meta.cloneNode(true));
    centerCol.appendChild(rouletteWrap);

    // assemble final layout: left + centerCol + right
    el.innerHTML = ''; // clear
    el.appendChild(left);
    el.appendChild(centerCol);
    el.appendChild(right);

    // prepare roulette content for this case
    prepareRouletteForCase(c, track);

    // click handlers
    el.addEventListener('click', (e)=>{
      if(e.target && e.target.dataset && e.target.dataset.open) return;
      toggleCaseRoulette(c.id);
    });
    const openBtn = el.querySelector('button[data-open]');
    openBtn.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      // show roulette and open once
      showCaseRoulette(c.id);
      openCaseInContainer(c.id, track);
    });

    casesListEl.appendChild(el);
  });
}

/* --- Show/hide roulette for a case --- */
function toggleCaseRoulette(caseId){
  const caseEl = document.querySelector(`.case[data-id="${caseId}"]`);
  if(!caseEl) return;
  const roulette = caseEl.querySelector('.roulette');
  if(!roulette) return;
  // hide other cases' roulettes
  document.querySelectorAll('.case .roulette').forEach(r => { if(r !== roulette) r.style.display = 'none'; });
  roulette.style.display = (roulette.style.display === 'none' || roulette.style.display === '') ? 'block' : 'none';
}
function showCaseRoulette(caseId){
  const caseEl = document.querySelector(`.case[data-id="${caseId}"]`);
  if(!caseEl) return;
  const roulette = caseEl.querySelector('.roulette');
  if(!roulette) return;
  document.querySelectorAll('.case .roulette').forEach(r => { if(r !== roulette) r.style.display = 'none'; });
  roulette.style.display = 'block';
}

/* --- Prepare roulette items for a specific case into provided track element --- */
function prepareRouletteForCase(caseObj, trackEl){
  trackEl.innerHTML = '';
  const items = [];
  for(let i=0;i<30;i++) caseObj.items.forEach(it => items.push(it));
  items.forEach(it=>{
    const el = document.createElement('div'); el.className = 'roulette-item';
    const img = document.createElement('img'); img.className='weapon-img';
    safeSetImg(img, it.img, it.name);
    el.appendChild(img);
    const name = document.createElement('div'); name.style.fontSize='11px'; name.style.marginTop='4px'; name.textContent = it.name;
    const price = document.createElement('div'); price.className='small'; price.textContent = it.price + ' ‚ÇΩ';
    el.appendChild(name); el.appendChild(price);
    trackEl.appendChild(el);
  });
  trackEl.style.transform = 'translateX(0)';
}

/* --- Open case: animate roulette inside that case's track --- */
function openCaseInContainer(caseId, trackEl){
  const c = WORK_CASES.find(x=>x.id===caseId);
  if(!c) return;
  const totalCost = c.price;
  if(state.balance < totalCost){ showModal(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ ${totalCost} ‚ÇΩ`, false); return; }
  state.balance -= totalCost; updateBalanceUI();

  const win = pickRandomItem(c.items);
  animateRouletteToInTrack(win, trackEl).then(()=> {
    const inv = { uid: uid('it'), id: win.id, name: win.name, price: win.price, img: win.img, upgraded: null };
    state.inventory.push(inv);
    showWin(inv);
    renderInventory();
    logOpen([win]);
  });
}

/* --- pickRandomItem --- */
function pickRandomItem(items){
  const total = items.reduce((s,it)=>s + (it.chance || 1),0);
  let r = Math.random()*total;
  for(const it of items){
    r -= (it.chance || 1);
    if(r <= 0) return JSON.parse(JSON.stringify(it));
  }
  return JSON.parse(JSON.stringify(items[items.length-1]));
}

/* --- animateRouletteToInTrack --- */
function animateRouletteToInTrack(item, trackEl){
  return new Promise(res=>{
    const nodes = Array.from(trackEl.children);
    let targetIndex = nodes.findIndex(n => n.textContent.includes(item.name));
    if(targetIndex === -1) targetIndex = Math.floor(nodes.length/2);
    const itemWidth = nodes[0].offsetWidth || 90;
    const visibleWidth = trackEl.parentElement.offsetWidth || 300;
    const centerOffset = Math.floor(visibleWidth/2);
    const targetCenter = targetIndex * itemWidth + itemWidth/2;
    const translateX = centerOffset - targetCenter;
    const duration = 1600 + Math.random()*800;
    trackEl.style.transition = `transform ${duration}ms cubic-bezier(.2,.9,.2,1)`;
    requestAnimationFrame(()=> trackEl.style.transform = `translateX(${translateX}px)`);
    setTimeout(()=>{ trackEl.style.transition = ''; res(); }, duration + 50);
  });
}

/* --- showWin --- */
function showWin(inv){
  safeSetImg(winImg, inv.img, inv.name);
  winTitle.textContent = inv.name;
  winPrice.textContent = `${inv.price} ‚ÇΩ`;
  winResultBox.style.display = 'block';
  overlay.style.display = 'flex';
  setTimeout(()=> { winResultBox.style.display = 'none'; }, 2500);
}

/* --- logOpen --- */
function logOpen(results){
  const lines = results.map(r=>`–í—ã –ø–æ–ª—É—á–∏–ª–∏: <b>${r.name}</b> ‚Äî ${r.price} ‚ÇΩ`).join('<br>');
  openLogEl.innerHTML = lines;
}

/* --- Inventory render with upgrade button that opens bottom panel --- */
function renderInventory(){
  inventoryListEl.innerHTML = '';
  if(state.inventory.length === 0){ inventoryListEl.innerHTML = '<div class="small">–ü—É—Å—Ç–æ</div>'; return; }
  state.inventory.slice().reverse().forEach(it=>{
    const el = document.createElement('div'); el.className = 'item';
    const left = document.createElement('div'); left.className='left';
    const img = document.createElement('img'); img.className='weapon-img'; safeSetImg(img, it.img, it.name);
    const meta = document.createElement('div'); meta.className='meta';
    const title = document.createElement('div'); title.className='title'; title.textContent = it.name + (it.upgraded ? ` ‚Ä¢ ${it.upgraded.multiplier}x` : '');
    const sub = document.createElement('div'); sub.className='sub'; sub.textContent = `${it.price} ‚ÇΩ`;
    meta.appendChild(title); meta.appendChild(sub);
    left.appendChild(img); left.appendChild(meta);

    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
    const sellBtn = document.createElement('button'); sellBtn.className='smallBtn'; sellBtn.textContent='–ü—Ä–æ–¥–∞—Ç—å';
    sellBtn.addEventListener('click', ()=>{
      state.balance += it.price;
      const idx = state.inventory.findIndex(x=>x.uid === it.uid);
      if(idx !== -1) state.inventory.splice(idx,1);
      updateBalanceUI(); renderInventory();
    });

    const upgBtn = document.createElement('button'); upgBtn.className='smallBtn'; upgBtn.style.marginTop='8px'; upgBtn.textContent='–ê–ø–≥—Ä–µ–π–¥';
    upgBtn.addEventListener('click', ()=> openUpgradePanelForItem(it));

    right.appendChild(sellBtn); right.appendChild(upgBtn);

    el.appendChild(left); el.appendChild(right);
    inventoryListEl.appendChild(el);
  });
}

/* --- Upgrade panel logic (bottom) --- */
let upgradeSelectedItem = null;
function openUpgradePanelForItem(item){
  upgradeSelectedItem = item;
  // preview
  upgradeSelectedPreview.innerHTML = '';
  const img = document.createElement('img'); img.style.width='64px'; img.style.height='64px'; img.style.borderRadius='8px';
  safeSetImg(img, item.img, item.name);
  upgradeSelectedPreview.appendChild(img);
  upgradeSelectedName.textContent = item.name;
  upgradeSelectedPrice.textContent = `${item.price} ‚ÇΩ`;
  upgradeResultSmall.textContent = '';
  upgradeInnerSmall.textContent = '–ê–ø–≥—Ä–µ–π–¥';
  // scroll to bottom so user sees panel (mobile)
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

/* --- Upgrade spin handlers (use same logic as modal) --- */
function performUpgrade(multiplier){
  if(!upgradeSelectedItem) { upgradeResultSmall.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ'; return; }
  const cost = multiplier === 2 ? Math.max(100, Math.round(upgradeSelectedItem.price * 0.18)) : Math.max(200, Math.round(upgradeSelectedItem.price * 0.35));
  if(state.balance < cost){ upgradeResultSmall.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏'; return; }
  state.balance -= cost; updateBalanceUI();
  upgradeResultSmall.textContent = '–ö—Ä—É—Ç–∏–º...';
  const prob = multiplier === 2 ? 0.60 : 0.30;
  const success = Math.random() < prob;
  const wheel = document.getElementById('upgradeWheelSmall');
  const baseSpins = 3 + Math.floor(Math.random()*3);
  let finalAngle;
  if(success) finalAngle = 360 * baseSpins + (Math.random()*50 + 5);
  else finalAngle = 360 * baseSpins + (Math.random()*180 + 120);
  wheel.style.transition = 'transform 2000ms cubic-bezier(.2,.9,.2,1)';
  wheel.style.transform = `rotate(${finalAngle}deg)`;
  setTimeout(()=> {
    wheel.style.transition = '';
    wheel.style.transform = `rotate(${finalAngle % 360}deg)`;
    if(success){
      upgradeSelectedItem.price = Math.round(upgradeSelectedItem.price * multiplier);
      upgradeSelectedItem.upgraded = upgradeSelectedItem.upgraded || { times:0, multiplier:1 };
      upgradeSelectedItem.upgraded.times += 1;
      upgradeSelectedItem.upgraded.multiplier *= multiplier;
      upgradeResultSmall.textContent = `–£—Å–ø–µ—Ö! –ü—Ä–µ–¥–º–µ—Ç —É–º–Ω–æ–∂–µ–Ω –Ω–∞ ${multiplier}x. –ù–æ–≤–∞—è —Ü–µ–Ω–∞: ${upgradeSelectedItem.price} ‚ÇΩ`;
      upgradeSelectedPrice.textContent = `${upgradeSelectedItem.price} ‚ÇΩ`;
    } else {
      upgradeResultSmall.textContent = '–ù–µ—É–¥–∞—á–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –ø—Ä–æ–¥–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.';
    }
    renderInventory();
  }, 2050);
}
upgrade2xBtn.addEventListener('click', ()=> performUpgrade(2));
upgrade3xBtn.addEventListener('click', ()=> performUpgrade(3));

/* --- Bank / demo deposit/withdraw --- */
bankBtn.addEventListener('click', ()=> bankOverlay.style.display = 'flex');
closeBank.addEventListener('click', ()=> bankOverlay.style.display = 'none');
depositBtn.addEventListener('click', ()=> {
  showModal('–î–µ–º–æ: –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ. –í —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç ‚Äî 100 ‚ÇΩ.', false);
});
withdrawBtn.addEventListener('click', ()=> {
  const val = Number(amountInput.value) || 0;
  if(val < 500) return showModal('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ ‚Äî 500 ‚ÇΩ', false);
  if(val > state.balance) return showModal('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞', false);
  state.balance -= val; updateBalanceUI(); bankOverlay.style.display = 'none'; showModal(`–í—ã–≤–µ–¥–µ–Ω–æ ${val} ‚ÇΩ (–¥–µ–º–æ)`, false);
});

/* --- Bonus 10 ‚ÇΩ per day (anti-abuse by date) --- */
function todayKey(){ const d = new Date(); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
bonusBtn.addEventListener('click', ()=>{
  const last = localStorage.getItem('lastBonusDate');
  const today = todayKey();
  if(last === today){ bonusMsg.textContent = '–ë–æ–Ω—É—Å —É–∂–µ –ø–æ–ª—É—á–µ–Ω —Å–µ–≥–æ–¥–Ω—è'; setTimeout(()=> bonusMsg.textContent = '', 2500); return; }
  state.balance += 10; updateBalanceUI(); localStorage.setItem('lastBonusDate', today);
  bonusMsg.textContent = '–ë–æ–Ω—É—Å 10 ‚ÇΩ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞—á–∏—Å–ª–µ–Ω'; setTimeout(()=> bonusMsg.textContent = '', 3000);
});

/* --- Helper: showModal --- */
function showModal(text, showWinBox=true){
  document.getElementById('modalContent').innerHTML = text;
  if(showWinBox) winResultBox.style.display = 'none';
  overlay.style.display = 'flex';
}
overlay.addEventListener('click', (e)=> { if(e.target === overlay) overlay.style.display = 'none'; });
closeModal.addEventListener('click', ()=> overlay.style.display = 'none');

/* --- Init: apply hidden RTP adjustments (keeps house edge) and render --- */
function applyHiddenRtp(targetRtp){
  WORK_CASES.forEach(c => {
    const items = c.items;
    const avgPrice = items.reduce((s,i)=>s+i.price,0)/items.length;
    const baseChances = items.map(i => i.baseChance || 1);
    const factor = Math.max(0.2, targetRtp);
    const newChances = items.map((it, idx) => {
      const rel = it.price / avgPrice;
      const val = baseChances[idx] * (1 / (1 + (rel - 1) * (1.2 - factor)));
      return Math.max(val, 0.01);
    });
    items.forEach((it, idx) => it.chance = newChances[idx]);
  });
}

function init(){
  applyHiddenRtp(state.currentRtp);
  renderCases();
  updateBalanceUI();
  renderInventory();
  try { if(window.TelegramWebApp && window.TelegramWebApp.MainButton) window.TelegramWebApp.MainButton.hide(); } catch(e){}
}
init();

/* --- Keyboard shortcuts for testing --- */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'b') bonusBtn.click();
  if(e.key === 'o') {
    // open first visible case's roulette and open once
    const firstOpenBtn = document.querySelector('.case button[data-open]');
    if(firstOpenBtn) firstOpenBtn.click();
  }
});
</script>
</body>
</html>